<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cobros Inteligente V5 - Seguimiento Automático</title>
    <meta name="description" content="Sistema profesional de cobros con IA y seguimiento automático para corredores de seguros">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>💼</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .pro-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .upload-area.processing {
            border-color: #f39c12;
            background: #fef9e7;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pendiente { background: #fff3cd; color: #856404; }
        .status-contactado { background: #d1ecf1; color: #0c5460; }
        .status-pagado { background: #d4edda; color: #155724; }
        .status-vencido { background: #f8d7da; color: #721c24; }
        .status-seguimiento { background: #e2e3ff; color: #3730a3; }
        .status-comprobante { background: #fef3c7; color: #92400e; }

        /* Action Buttons */
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-email { background: #e74c3c; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-paid { background: #27ae60; color: white; }
        .btn-auto { background: #9b59b6; color: white; }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid #3498db;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .ai-prediction {
            font-size: 12px;
            color: #e74c3c;
            font-weight: bold;
            margin-top: 5px;
        }

        /* AI Score Circle */
        .ai-score-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin: 0 auto;
        }

        .priority-high {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
        }

        .priority-medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.3);
        }

        .priority-low {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3);
        }

        /* Seguimiento Automático */
        .auto-follow-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .auto-follow-active {
            background: #d4edda;
            color: #155724;
        }

        .auto-follow-paused {
            background: #f8d7da;
            color: #721c24;
        }

        /* Notifications */
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 1000;
            space-y: 10px;
        }

        .notification {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            animation: slideIn 0.3s ease;
        }

        .notification.payment {
            border-left-color: #27ae60;
        }

        .notification.alert {
            border-left-color: #f39c12;
        }

        .notification.urgent {
            border-left-color: #e74c3c;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: 500;
            position: relative;
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: none;
                min-width: 120px;
                font-size: 12px;
                padding: 12px 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .stat-number {
                font-size: 1.8em;
            }

            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        /* Nuevos estilos para funcionalidades V5 */
        .seguimiento-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .comprobante-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .comprobante-pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .comprobante-verificado {
            background: #d1fae5;
            color: #065f46;
        }

        .auto-message-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3498db;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="pro-badge">🚀 V5 COMPLETO</div>
            <h1>💼 Sistema de Cobros Inteligente V5</h1>
            <p>Sistema Profesional con Seguimiento Automático - Costa Rica</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showTab('carga')">📥 Cargar Datos</button>
            <button class="nav-tab" onclick="showTab('cartera')">📋 Gestión Cartera</button>
            <button class="nav-tab" onclick="showTab('seguimiento')">🤖 Seguimiento Auto</button>
            <button class="nav-tab" onclick="showTab('comprobantes')">📄 Comprobantes</button>
            <button class="nav-tab" onclick="showTab('comunicacion')">📧 Comunicación</button>
            <button class="nav-tab" onclick="showTab('reportes')">📊 Reportes</button>
            <button class="nav-tab" onclick="showTab('configuracion')">⚙️ Configuración</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>📊 Dashboard Principal</h2>
            
            <!-- Seguimiento Automático Status -->
            <div class="seguimiento-card">
                <h3>🤖 Sistema de Seguimiento Automático</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">ACTIVO</div>
                        <div style="opacity: 0.8;">Estado del Sistema</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">28</div>
                        <div style="opacity: 0.8;">En Seguimiento</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">847</div>
                        <div style="opacity: 0.8;">Mensajes Hoy</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">89%</div>
                        <div style="opacity: 0.8;">Efectividad</div>
                    </div>
                </div>
            </div>

            <!-- Alertas Tiempo Real -->
            <div class="alert alert-warning">
                <h4>🔔 Alertas en Tiempo Real</h4>
                <div id="alertasTimepo" style="margin-top: 10px;">
                    <div class="timeline-item">
                        <div class="timeline-dot" style="background: #27ae60;"></div>
                        <span><strong>María González</strong> reportó pago - Solicitar comprobante</span>
                        <span style="margin-left: auto; font-size: 12px; color: #666;">Hace 2 min</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot" style="background: #f39c12;"></div>
                        <span><strong>Carlos Ramírez</strong> no responde - 15 intentos automáticos</span>
                        <span style="margin-left: auto; font-size: 12px; color: #666;">Hace 1 hora</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot" style="background: #3498db;"></div>
                        <span><strong>Ana Vega</strong> subió comprobante - Verificar</span>
                        <span style="margin-left: auto; font-size: 12px; color: #666;">Hace 3 horas</span>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalClientes">0</div>
                    <div class="stat-label">Total Clientes</div>
                    <div class="ai-prediction" id="clientesInfo">Sin datos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="montoPendiente">₡0</div>
                    <div class="stat-label">Monto Pendiente</div>
                    <div class="ai-prediction" id="montoInfo">Sin datos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="clientesVencidos">0</div>
                    <div class="stat-label">Vencidos</div>
                    <div class="ai-prediction" id="vencidosInfo">Sin datos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="scorePromedio">0%</div>
                    <div class="stat-label">Score Promedio</div>
                    <div class="ai-prediction" id="scoreInfo">Sin datos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="seguimientoActivo">28</div>
                    <div class="stat-label">Seguimiento Activo</div>
                    <div class="ai-prediction">Sistema automático</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="comprobantesPendientes">5</div>
                    <div class="stat-label">Comprobantes Pendientes</div>
                    <div class="ai-prediction">Requieren verificación</div>
                </div>
            </div>

            <!-- Resumen Ejecutivo -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h3>📋 Resumen Ejecutivo</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <strong>📂 Estado:</strong> <span id="summaryStatus">Sistema activo con 28 clientes en seguimiento</span>
                    </div>
                    <div>
                        <strong>🎯 Siguiente acción:</strong> <span id="nextAction">Verificar 5 comprobantes pendientes</span>
                    </div>
                    <div>
                        <strong>⚡ Recomendación:</strong> <span id="recommendation">Revisar clientes sin respuesta después de 15 intentos</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Carga de Datos -->
        <div id="carga" class="tab-content">
            <h2>📥 Carga de Datos Excel</h2>
            
            <!-- Sección de Plantillas -->
            <div class="section" style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid #27ae60;">
                <h3>📋 ¿Primera vez? Descarga una Plantilla</h3>
                <p>Descarga una plantilla con el formato correcto para empezar:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <button class="upload-btn" onclick="descargarPlantillaVacia()" style="background: #27ae60;">
                        📋 Plantilla Vacía
                        <br><small style="opacity: 0.8;">Para llenar con tus datos</small>
                    </button>
                    <button class="upload-btn" onclick="descargarEjemploCompleto()" style="background: #3498db;">
                        📊 Ejemplo con Datos
                        <br><small style="opacity: 0.8;">Para ver el formato correcto</small>
                    </button>
                    <button class="upload-btn" onclick="descargarPlantillaINS()" style="background: #e74c3c;">
                        🏢 Solo INS
                        <br><small style="opacity: 0.8;">Específica para INS</small>
                    </button>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div id="uploadContent">
                    <h3>📁 Sube tu archivo Excel de cartera</h3>
                    <p>Formatos soportados: .xlsx, .xls</p>
                    <p>El sistema detectará automáticamente las columnas y iniciará el seguimiento automático</p>
                    <button type="button" class="upload-btn">Seleccionar Archivo Excel</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="loadExcelFile(this)">
                </div>
                <div id="processingContent" style="display: none;">
                    <h3>🤖 Procesando archivo e iniciando seguimiento automático...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="processingStatus">Analizando datos...</p>
                </div>
            </div>

            <div id="fileInfo" style="display: none;">
                <div class="alert alert-success">
                    <strong>📊 Archivo procesado:</strong> <span id="fileName"></span><br>
                    <strong>📈 Registros encontrados:</strong> <span id="recordCount">0</span><br>
                    <strong>🕒 Procesado:</strong> <span id="processTime"></span><br>
                    <strong>🤖 Seguimiento automático:</strong> <span style="color: #27ae60; font-weight: bold;">ACTIVADO</span>
                </div>
            </div>

            <div id="columnMapping" style="display: none;">
                <h3>🔗 Mapeo de Columnas</h3>
                <div id="mappingGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;"></div>
            </div>

            <div id="dataValidation" style="display: none;">
                <h3>✅ Validación de Datos</h3>
                <div id="validationResults"></div>
            </div>

            <button onclick="processRealData()" class="upload-btn" id="processBtn" style="opacity: 0.5;" disabled>
                🤖 Procesar Datos con IA y Activar Seguimiento
            </button>
        </div>

        <!-- Tab Gestión Cartera -->
        <div id="cartera" class="tab-content">
            <h2>📋 Gestión de Cartera</h2>
            
            <div class="filter-section" id="filterSection" style="display: none;">
                <h3>🎯 Filtros</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>Estado:</label>
                        <select class="form-control" id="filtroEstado" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Contactado">Contactado</option>
                            <option value="Pagado">Pagado</option>
                            <option value="Vencido">Vencido</option>
                            <option value="SeguimientoAuto">Seguimiento Automático</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Score IA:</label>
                        <select class="form-control" id="filtroScore" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="high">Alto (>70%)</option>
                            <option value="medium">Medio (40-70%)</option>
                            <option value="low">Bajo (<40%)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Seguimiento:</label>
                        <select class="form-control" id="filtroSeguimiento" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="activo">Seguimiento Activo</option>
                            <option value="pausado">Pausado</option>
                            <option value="completado">Completado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Búsqueda:</label>
                        <input type="text" class="form-control" id="busquedaTexto" placeholder="Buscar cliente..." onkeyup="aplicarFiltros()">
                    </div>
                </div>
            </div>

            <div style="text-align: right; margin-bottom: 15px;">
                <button class="upload-btn" onclick="exportarExcel()" id="exportBtn" style="display: none; background: #27ae60;">📊 Exportar Excel</button>
                <button class="upload-btn" onclick="comunicacionMasiva()" id="commBtn" style="display: none; background: #e74c3c;">🚀 Comunicación Masiva</button>
                <button class="upload-btn" onclick="pausarSeguimientoMasivo()" id="pauseBtn" style="display: none; background: #f39c12;">⏸️ Pausar Seguimiento</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Score IA</th>
                            <th>Póliza</th>
                            <th>Monto</th>
                            <th>Vencimiento</th>
                            <th>Estado</th>
                            <th>Seguimiento Auto</th>
                            <th>Comprobante</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCarteraBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                                📁 Carga tu archivo Excel para ver los datos aquí
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Seguimiento Automático -->
        <div id="seguimiento" class="tab-content">
            <h2>🤖 Sistema de Seguimiento Automático</h2>
            
            <!-- Control Principal -->
            <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h3>⚙️ Control Principal del Sistema</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span class="auto-follow-status" id="sistemaEstado">
                            <span style="width: 8px; height: 8px; background: #27ae60; border-radius: 50%; display: inline-block;"></span>
                            SISTEMA ACTIVO
                        </span>
                        <button class="upload-btn" onclick="toggleSeguimientoAutomatico()" id="toggleSeguimiento" style="background: #e74c3c;">
                            ⏸️ Pausar Sistema
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #3498db;">48h</div>
                        <div style="font-size: 14px; color: #666;">Intervalo Contactos</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">20</div>
                        <div style="font-size: 14px; color: #666;">Máximo Intentos</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;">89%</div>
                        <div style="font-size: 14px; color: #666;">Efectividad</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #9b59b6;">28</div>
                        <div style="font-size: 14px; color: #666;">Clientes Activos</div>
                    </div>
                </div>
            </div>

            <!-- Configuración Avanzada -->
            <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px;">
                <h3>⚙️ Configuración del Seguimiento</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                    <div>
                        <h4>📋 Parámetros Generales</h4>
                        <div class="form-group">
                            <label>Intervalo entre contactos (horas)</label>
                            <input type="number" class="form-control" id="intervaloHoras" value="48">
                        </div>
                        <div class="form-group">
                            <label>Máximo intentos por cliente</label>
                            <input type="number" class="form-control" id="maxIntentos" value="20">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="escalamientoAuto" checked> 
                                Escalamiento automático después de 15 intentos
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="solicitudComprobante" checked> 
                                Solicitar comprobante automáticamente al reportar pago
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <h4>📱 Canales de Comunicación</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="canalWhatsApp" checked> 
                                WhatsApp (Principal)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="canalEmail" checked> 
                                Email de respaldo
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="canalSMS"> 
                                SMS (Casos urgentes)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Horario de envío</label>
                            <select class="form-control" id="horarioEnvio">
                                <option value="8-18">8:00 AM - 6:00 PM</option>
                                <option value="9-17">9:00 AM - 5:00 PM</option>
                                <option value="24h">24 Horas</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="upload-btn" onclick="guardarConfigSeguimiento()">💾 Guardar Configuración</button>
                </div>
            </div>

            <!-- Plantillas de Mensajes Automáticos -->
            <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                <h3>💬 Plantillas de Mensajes Automáticos</h3>
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4>Fase 1: Recordatorio Inicial (Intentos 1-5)</h4>
                        <textarea class="form-control" rows="4" id="plantillaInicial">Hola {CLIENTE}, le recordamos que su póliza {POLIZA} de {ASEGURADORA} vence el {VENCIMIENTO}. 

Monto: {MONTO}
Para mantener su cobertura activa, puede pagar en línea o contactarnos.

Si ya realizó el pago, responda "PAGUÉ" con el comprobante.

Saludos,
{CORREDOR}</textarea>
                        <div class="auto-message-preview">
                            <strong>Vista previa:</strong><br>
                            Hola María González, le recordamos que su póliza 0104AUT0261819-00 de INS vence el 15/12/2024...
                        </div>
                    </div>
                    
                    <div>
                        <h4>Fase 2: Recordatorio Urgente (Intentos 6-12)</h4>
                        <textarea class="form-control" rows="4" id="plantillaUrgente">URGENTE: {CLIENTE}, su póliza {POLIZA} está VENCIDA.

🚨 Días vencido: {DIAS_VENCIDO}
💰 Monto: {MONTO}
🏢 Aseguradora: {ASEGURADORA}

Su cobertura puede ser cancelada. Para evitarlo:
1️⃣ Pague inmediatamente
2️⃣ Responda "PAGUÉ" si ya pagó
3️⃣ Contacte para facilidades: {TELEFONO}

{CORREDOR}</textarea>
                    </div>
                    
                    <div>
                        <h4>Fase 3: Último Aviso (Intentos 13-20)</h4>
                        <textarea class="form-control" rows="4" id="plantillaFinal">⚠️ ÚLTIMO AVISO - {CLIENTE}

Su póliza {POLIZA} será CANCELADA en 24 horas.

❌ Sin cobertura = Sin protección
💸 Monto adeudado: {MONTO}
📞 Última oportunidad: {TELEFONO}

Si ya pagó, RESPONDA INMEDIATAMENTE con el comprobante.

ACCIÓN URGENTE REQUERIDA.
{CORREDOR}</textarea>
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="upload-btn" onclick="guardarPlantillas()">💾 Guardar Plantillas</button>
                    <button class="upload-btn" onclick="previsualizarMensajes()" style="background: #9b59b6;">👁️ Previsualizar</button>
                </div>
            </div>
        </div>

        <!-- Tab Comprobantes -->
        <div id="comprobantes" class="tab-content">
            <h2>📄 Gestión de Comprobantes de Pago</h2>
            
            <!-- Alerta de Comprobantes Pendientes -->
            <div class="alert alert-warning">
                <h4>🔔 Alertas de Comprobantes</h4>
                <p><strong>5 comprobantes pendientes</strong> de verificación. Los clientes pagaron directamente a la aseguradora.</p>
                <button class="upload-btn" onclick="procesarComprobantesPendientes()">🚀 Procesar Todos</button>
            </div>

            <!-- Lista de Comprobantes -->
            <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px;">
                <h3>📋 Lista de Comprobantes</h3>
                
                <div style="display: grid; gap: 15px; margin-top: 20px;" id="listaComprobantes">
                    <!-- Comprobante Pendiente -->
                    <div style="border: 2px solid #f39c12; border-radius: 10px; padding: 20px; background: #fffbf3;">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: #333;">María González Castro</h4>
                                <p style="margin: 5px 0; color: #666;">Póliza: 0104AUT0261819-00 • ₡45,000</p>
                                <span class="comprobante-status comprobante-pendiente">⏳ COMPROBANTE PENDIENTE</span>
                                <p style="margin: 5px 0; font-size: 12px; color: #f39c12;"><strong>Cliente reportó pago hace 2 horas</strong></p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn" style="background: #3498db;" onclick="solicitarComprobante('maria')">📱 Solicitar</button>
                                <button class="action-btn" style="background: #27ae60;" onclick="subirComprobante('maria')">📎 Subir</button>
                                <button class="action-btn" style="background: #e74c3c;" onclick="marcarComoPagado('maria')">✅ Confirmar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Comprobante Verificado -->
                    <div style="border: 2px solid #27ae60; border-radius: 10px; padding: 20px; background: #f0f9f0;">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: #333;">Ana Patricia Vega</h4>
                                <p style="margin: 5px 0; color: #666;">Póliza: 0105VID0312456-02 • ₡75,000</p>
                                <span class="comprobante-status comprobante-verificado">✅ VERIFICADO</span>
                                <p style="margin: 5px 0; font-size: 12px; color: #27ae60;"><strong>Comprobante validado - Listo para reportar</strong></p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn" style="background: #3498db;" onclick="verComprobante('ana')">👁️ Ver</button>
                                <button class="action-btn" style="background: #9b59b6;" onclick="reportarAseguradora('ana')">📤 Reportar</button>
                                <button class="action-btn" style="background: #27ae60;" onclick="descargarComprobante('ana')">💾 Descargar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sin Respuesta -->
                    <div style="border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; background: #fdf2f2;">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: #333;">Carlos Ramírez Soto</h4>
                                <p style="margin: 5px 0; color: #666;">Póliza: 0104RCG0000138-08 • ₡125,000</p>
                                <span class="status-badge status-vencido">❌ SIN RESPUESTA</span>
                                <p style="margin: 5px 0; font-size: 12px; color: #e74c3c;"><strong>15 intentos automáticos - 12 días vencido</strong></p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn" style="background: #f39c12;" onclick="llamarCliente('carlos')">📞 Llamar</button>
                                <button class="action-btn" style="background: #e74c3c;" onclick="escalarCliente('carlos')">🚨 Escalar</button>
                                <button class="action-btn" style="background: #6c757d;" onclick="pausarSeguimiento('carlos')">⏸️ Pausar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas Comprobantes -->
            <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                <h3>📊 Estadísticas de Comprobantes</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid #3498db;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #3498db;">43</div>
                        <div style="color: #666;">Comprobantes este mes</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #fffbf3; border-radius: 10px; border-left: 5px solid #f39c12;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #f39c12;">5</div>
                        <div style="color: #666;">Pendientes verificación</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f0f9f0; border-radius: 10px; border-left: 5px solid #27ae60;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #27ae60;">38</div>
                        <div style="color: #666;">Verificados y reportados</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8f0ff; border-radius: 10px; border-left: 5px solid #9b59b6;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #9b59b6;">1.8h</div>
                        <div style="color: #666;">Tiempo promedio proceso</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Comunicación -->
        <div id="comunicacion" class="tab-content">
            <h2>📧 Centro de Comunicación</h2>
            
            <div class="form-group">
                <h3>📝 Plantillas de Mensajes</h3>
                
                <div class="form-group">
                    <label>📧 Plantilla Email:</label>
                    <textarea class="form-control" id="plantillaEmail" rows="10">Estimado/a {CLIENTE},

Le escribo en relación a su póliza {POLIZA} por un monto de {MONTO}.

Detalles:
• Aseguradora: {ASEGURADORA}
• Vencimiento: {VENCIMIENTO}
• Estado: Pendiente de pago

Para mantener su cobertura activa, es importante realizar el pago antes de la fecha de vencimiento.

Si ya realizó el pago, por favor responda con el comprobante.
Si necesita facilidades de pago, no dude en contactarnos.

Cordialmente,
{CORREDOR}
Tel: {TELEFONO}</textarea>
                </div>

                <div class="form-group">
                    <label>💬 Plantilla WhatsApp:</label>
                    <textarea class="form-control" id="plantillaWhatsApp" rows="8">Hola {CLIENTE}!

Su póliza {POLIZA} vence el {VENCIMIENTO}.
Monto: {MONTO}

Para mantener su cobertura, puede pagar:
• SINPE Móvil: {TELEFONO}
• Transferencia bancaria
• Efectivo en oficina

¿Ya pagó? Responda "PAGUÉ" + comprobante
¿Necesita ayuda? Responda "AYUDA"

Saludos,
{CORREDOR}</textarea>
                </div>
            </div>

            <div id="comunicacionTools" style="display: none;">
                <h3>🚀 Herramientas de Comunicación</h3>
                <button class="upload-btn" onclick="enviarEmailsMasivos()">📧 Envío Masivo Email</button>
                <button class="upload-btn" onclick="enviarWhatsAppMasivo()" style="background: #25d366;">💬 Envío Masivo WhatsApp</button>
                <button class="upload-btn" onclick="activarSeguimientoMasivo()" style="background: #9b59b6;">🤖 Activar Seguimiento Auto</button>
            </div>
        </div>

        <!-- Tab Reportes -->
        <div id="reportes" class="tab-content">
            <h2>📊 Reportes y Análisis</h2>
            
            <div id="reportesTools" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <button class="upload-btn" onclick="generarReporteCartera()" style="background: #2c3e50; padding: 20px;">
                        <div>📋 Reporte de Cartera</div>
                        <small>Estado actual completo</small>
                    </button>
                    
                    <button class="upload-btn" onclick="generarReporteSeguimiento()" style="background: #9b59b6; padding: 20px;">
                        <div>🤖 Reporte Seguimiento Automático</div>
                        <small>Efectividad del sistema</small>
                    </button>
                    
                    <button class="upload-btn" onclick="generarReporteComprobantes()" style="background: #f39c12; padding: 20px;">
                        <div>📄 Reporte Comprobantes</div>
                        <small>Estados y tiempos</small>
                    </button>
                    
                    <button class="upload-btn" onclick="generarReporteVencimientos()" style="background: #e74c3c; padding: 20px;">
                        <div>⚠️ Reporte Vencimientos</div>
                        <small>Clientes por vencer</small>
                    </button>
                    
                    <button class="upload-btn" onclick="generarReporteAseguradoras()" style="background: #27ae60; padding: 20px;">
                        <div>🏢 Por Aseguradora</div>
                        <small>Análisis por compañía</small>
                    </button>
                    
                    <button class="upload-btn" onclick="generarReporteEjecutivo()" style="background: #3498db; padding: 20px;">
                        <div>📈 Reporte Ejecutivo</div>
                        <small>Resumen gerencial</small>
                    </button>
                </div>
            </div>

            <div id="reporteResultados">
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #666;">📊 Área de Reportes</h3>
                    <p style="color: #666;">Carga datos para generar reportes detallados con seguimiento automático</p>
                </div>
            </div>
        </div>

        <!-- Tab Configuración -->
        <div id="configuracion" class="tab-content">
            <h2>⚙️ Configuración del Sistema</h2>
            
            <div class="form-group">
                <h3>👤 Información del Corredor</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label>Nombre Completo:</label>
                        <input type="text" class="form-control" id="nombreCorrector" placeholder="Su nombre completo">
                    </div>
                    <div>
                        <label>Teléfono:</label>
                        <input type="text" class="form-control" id="telefonoCorrector" placeholder="8888-7777">
                    </div>
                    <div>
                        <label>Email:</label>
                        <input type="email" class="form-control" id="emailCorrector" placeholder="corredor@ejemplo.com">
                    </div>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; margin: 25px 0;">
                <h3>🤖 Configuración IA y Seguimiento Automático</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="form-group">
                        <label style="color: white;">🎯 Sensibilidad del Score (1-10):</label>
                        <input type="range" class="form-control" id="aiSensitivity" min="1" max="10" value="7" 
                               onchange="document.getElementById('sensitivityValue').textContent = this.value">
                        <small style="color: rgba(255,255,255,0.8);">Nivel: <span id="sensitivityValue">7</span>/10</small>
                    </div>

                    <div class="form-group">
                        <label style="color: white;">🧠 Algoritmo de Análisis:</label>
                        <select class="form-control" id="aiAlgorithm">
                            <option value="balanced">Balanceado</option>
                            <option value="conservative">Conservador</option>
                            <option value="aggressive">Agresivo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="color: white;">⏰ Modo Seguimiento:</label>
                        <select class="form-control" id="modoSeguimiento">
                            <option value="24h">24 Horas</option>
                            <option value="business">Horario Comercial</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="color: white;">🚀 Intensidad Seguimiento:</label>
                        <select class="form-control" id="intensidadSeguimiento">
                            <option value="suave">Suave (48h intervalo)</option>
                            <option value="normal">Normal (24h intervalo)</option>
                            <option value="intensivo">Intensivo (12h intervalo)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">
                <h4>💾 Datos del Sistema</h4>
                <div id="systemStats">
                    <p><strong>Registros cargados:</strong> <span id="configRegistros">0</span></p>
                    <p><strong>Última carga:</strong> <span id="configUltimaCarga">Nunca</span></p>
                    <p><strong>Configuración:</strong> <span id="configEstado">Pendiente</span></p>
                    <p><strong>Seguimiento automático:</strong> <span id="configSeguimiento">Activo</span></p>
                    <p><strong>Comprobantes pendientes:</strong> <span id="configComprobantes">5</span></p>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="upload-btn" onclick="guardarConfiguracion()">💾 Guardar Configuración</button>
                <button class="upload-btn" onclick="exportarConfiguracion()" style="background: #9b59b6;">📤 Exportar Config</button>
                <button class="upload-btn" onclick="importarConfiguracion()" style="background: #f39c12;">📥 Importar Config</button>
                <button class="upload-btn" onclick="limpiarDatos()" style="background: #e74c3c;">🗑️ Limpiar Datos</button>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>📋 Detalles del Cliente</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Panel de Notificaciones -->
    <div id="notificationPanel" class="notification-panel"></div>

    <script>
        // Variables globales
        let datosCartera = [];
        let datosOriginales = [];
        let seguimientoAutomaticoActivo = true;
        let configuracion = {
            nombreCorrector: '',
            telefonoCorrector: '',
            emailCorrector: '',
            aiSensitivity: 7,
            aiAlgorithm: 'balanced',
            modoSeguimiento: '24h',
            intensidadSeguimiento: 'normal'
        };

        // Datos de ejemplo del sistema de seguimiento
        let clientesEjemplo = [
            {
                id: 1,
                cliente: 'María González Castro',
                poliza: '0104AUT0261819-00',
                aseguradora: 'INS',
                monto: 45000,
                vencimiento: '2024-12-15',
                telefono: '8888-7777',
                email: 'maria.gonzalez@email.com',
                estado: 'SeguimientoAuto',
                tipoSeguro: 'AUTO',
                aiScore: 85,
                intentosContacto: 8,
                ultimoContacto: '2024-12-10 14:30',
                proximoContacto: '2024-12-11 09:00',
                seguimientoActivo: true,
                comprobantePendiente: true,
                fechaCarga: new Date().toISOString()
            },
            {
                id: 2,
                cliente: 'Carlos Ramírez Soto',
                poliza: '0104RCG0000138-08',
                aseguradora: 'INS',
                monto: 125000,
                vencimiento: '2024-12-08',
                telefono: '8777-6666',
                email: 'carlos.ramirez@email.com',
                estado: 'Vencido',
                tipoSeguro: 'RCG',
                aiScore: 25,
                intentosContacto: 15,
                ultimoContacto: '2024-12-08 16:45',
                proximoContacto: null,
                seguimientoActivo: false,
                comprobantePendiente: false,
                fechaCarga: new Date().toISOString()
            },
            {
                id: 3,
                cliente: 'Ana Patricia Vega',
                poliza: '0105VID0312456-02',
                aseguradora: 'Mapfre',
                monto: 75000,
                vencimiento: '2025-01-10',
                telefono: '8999-1234',
                email: 'ana.vega@email.com',
                estado: 'Pagado',
                tipoSeguro: 'VIDA',
                aiScore: 95,
                intentosContacto: 3,
                ultimoContacto: '2024-12-10 11:20',
                proximoContacto: null,
                seguimientoActivo: false,
                comprobantePendiente: false,
                fechaCarga: new Date().toISOString()
            }
        ];

        // Mapeo de aseguradoras
        const aseguradoras = {
            '0104': 'INS (Instituto Nacional de Seguros)',
            '0105': 'Mapfre Costa Rica',
            '0106': 'BCR Seguros',
            '0107': 'Sagicor Costa Rica',
            '0108': 'Equinoccio Seguros',
            '0109': 'Assa Compañía de Seguros'
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracion();
            setupDragAndDrop();
            cargarDatosGuardados();
            mostrarNotificacion('Sistema V5 iniciado - Seguimiento automático activo', 'success');
            
            // Cargar datos de ejemplo si no hay datos
            if (datosCartera.length === 0) {
                datosCartera = [...clientesEjemplo];
                datosOriginales = [...clientesEjemplo];
                actualizarDashboard();
                actualizarTablaCartera();
                mostrarElementosCartera();
            }

            // Simular alertas en tiempo real
            setTimeout(() => {
                mostrarNotificacion('María González reportó pago - Verificar comprobante', 'payment');
            }, 3000);

            setTimeout(() => {
                mostrarNotificacion('Carlos Ramírez - 15 intentos sin respuesta', 'alert');
            }, 8000);
        });

        // Gestión de pestañas
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // Control del seguimiento automático
        function toggleSeguimientoAutomatico() {
            seguimientoAutomaticoActivo = !seguimientoAutomaticoActivo;
            const btn = document.getElementById('toggleSeguimiento');
            const status = document.getElementById('sistemaEstado');
            
            if (seguimientoAutomaticoActivo) {
                btn.innerHTML = '⏸️ Pausar Sistema';
                btn.style.background = '#e74c3c';
                status.innerHTML = '<span style="width: 8px; height: 8px; background: #27ae60; border-radius: 50%; display: inline-block;"></span> SISTEMA ACTIVO';
                status.className = 'auto-follow-status auto-follow-active';
                mostrarNotificacion('Seguimiento automático reactivado', 'success');
            } else {
                btn.innerHTML = '▶️ Activar Sistema';
                btn.style.background = '#27ae60';
                status.innerHTML = '<span style="width: 8px; height: 8px; background: #e74c3c; border-radius: 50%; display: inline-block;"></span> SISTEMA PAUSADO';
                status.className = 'auto-follow-status auto-follow-paused';
                mostrarNotificacion('Seguimiento automático pausado', 'alert');
            }
        }

        // Funciones de carga de archivo Excel (mantiene funcionalidad original)
        function loadExcelFile(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                mostrarNotificacion('Error: Solo se permiten archivos Excel (.xlsx, .xls)', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                mostrarNotificacion('Error: Archivo demasiado grande (máximo 10MB)', 'error');
                return;
            }

            mostrarProcesamientoUI();
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    procesarArchivoReal(jsonData, file.name);
                    
                } catch (error) {
                    mostrarNotificacion('Error al procesar archivo: ' + error.message, 'error');
                    resetearUploadUI();
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function procesarArchivoReal(data, fileName) {
            if (!data || data.length < 2) {
                mostrarNotificacion('El archivo está vacío o no tiene datos válidos', 'error');
                resetearUploadUI();
                return;
            }

            let progress = 0;
            const progressBar = document.getElementById('progressFill');
            const statusText = document.getElementById('processingStatus');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                statusText.textContent = progress < 30 ? 'Analizando estructura...' : 
                                       progress < 60 ? 'Validando datos...' :
                                       progress < 90 ? 'Configurando seguimiento automático...' : 'Finalizando...';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completarProcesamientoReal(data, fileName);
                }
            }, 200);
        }

        function completarProcesamientoReal(data, fileName) {
            try {
                const headers = data[0];
                const rows = data.slice(1);
                
                const columnMapping = detectarColumnas(headers);
                mostrarMapeoColumnas(columnMapping, headers);
                
                datosOriginales = convertirDatosReales(rows, columnMapping, headers);
                datosCartera = [...datosOriginales];
                
                calcularScoresIA();
                
                document.getElementById('recordCount').textContent = datosCartera.length;
                document.getElementById('processTime').textContent = new Date().toLocaleString();
                document.getElementById('fileInfo').style.display = 'block';
                
                mostrarValidacionDatos();
                
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = false;
                processBtn.style.opacity = '1';
                processBtn.innerHTML = '🤖 Datos Listos - Activar Seguimiento Automático';
                
                resetearUploadUI();
                guardarDatos();
                
                mostrarNotificacion(`Archivo procesado: ${datosCartera.length} registros cargados`, 'success');
                
            } catch (error) {
                mostrarNotificacion('Error procesando datos: ' + error.message, 'error');
                resetearUploadUI();
            }
        }

        function detectarColumnas(headers) {
            const mapping = {
                cliente: null,
                poliza: null,
                monto: null,
                vencimiento: null,
                aseguradora: null,
                telefono: null,
                email: null,
                formaPago: null
            };
            
            headers.forEach((header, index) => {
                const h = header.toString().toLowerCase();
                
                if (h.includes('asegurado') || h.includes('cliente') || h.includes('nombre')) {
                    mapping.cliente = index;
                } else if (h.includes('poliza') || h.includes('póliza') || h.includes('policy')) {
                    mapping.poliza = index;
                } else if (h.includes('monto') || h.includes('prima') || h.includes('valor')) {
                    mapping.monto = index;
                } else if (h.includes('vencimiento') || h.includes('vigencia') || h.includes('hasta')) {
                    mapping.vencimiento = index;
                } else if (h.includes('telefono') || h.includes('teléfono') || h.includes('cel')) {
                    mapping.telefono = index;
                } else if (h.includes('email') || h.includes('correo') || h.includes('mail')) {
                    mapping.email = index;
                } else if (h.includes('forma') && h.includes('pago')) {
                    mapping.formaPago = index;
                } else if (h.includes('aseguradora') || h.includes('compañía')) {
                    mapping.aseguradora = index;
                }
            });
            
            return mapping;
        }

        function mostrarMapeoColumnas(mapping, headers) {
            const grid = document.getElementById('mappingGrid');
            grid.innerHTML = '';
            
            Object.entries(mapping).forEach(([campo, index]) => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${campo}:</strong> ${index !== null ? headers[index] : 'No detectado'}`;
                if (index === null && ['cliente', 'poliza', 'monto'].includes(campo)) {
                    div.style.color = '#e74c3c';
                    div.innerHTML += ' ⚠️';
                }
                grid.appendChild(div);
            });
            
            document.getElementById('columnMapping').style.display = 'block';
        }

        function convertirDatosReales(rows, mapping, headers) {
            return rows.map((row, index) => {
                const poliza = mapping.poliza !== null ? (row[mapping.poliza] || '').toString() : '';
                const codigoAseg = poliza.substring(0, 4);
                
                let monto = 0;
                if (mapping.monto !== null && row[mapping.monto]) {
                    const montoStr = row[mapping.monto].toString().replace(/[^\d.,]/g, '');
                    monto = parseFloat(montoStr.replace(',', '.')) || 0;
                }
                
                return {
                    id: index + 1,
                    cliente: mapping.cliente !== null ? (row[mapping.cliente] || '').toString() : `Cliente ${index + 1}`,
                    poliza: poliza,
                    aseguradora: aseguradoras[codigoAseg] || 'Aseguradora Desconocida',
                    monto: monto,
                    vencimiento: mapping.vencimiento !== null ? formatearFechaExcel(row[mapping.vencimiento]) : '',
                    telefono: mapping.telefono !== null ? limpiarTelefono(row[mapping.telefono]) : '',
                    email: mapping.email !== null ? (row[mapping.email] || '').toString() : '',
                    formaPago: mapping.formaPago !== null ? (row[mapping.formaPago] || '').toString() : 'No especificado',
                    estado: determinarEstado(row[mapping.vencimiento]),
                    tipoSeguro: determinarTipoSeguro(poliza),
                    aiScore: 0,
                    aiPrediction: '',
                    aiRecommendation: '',
                    seguimientoActivo: true,
                    intentosContacto: 0,
                    ultimoContacto: null,
                    proximoContacto: null,
                    comprobantePendiente: false,
                    fechaCarga: new Date().toISOString()
                };
            }).filter(cliente => cliente.cliente && cliente.poliza);
        }

        function formatearFechaExcel(fecha) {
            if (!fecha) return '';
            
            if (typeof fecha === 'number') {
                const excelEpoch = new Date(1900, 0, 1);
                const date = new Date(excelEpoch.getTime() + (fecha - 1) * 24 * 60 * 60 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            try {
                const date = new Date(fecha);
                return isNaN(date.getTime()) ? fecha.toString() : date.toISOString().split('T')[0];
            } catch {
                return fecha.toString();
            }
        }

        function limpiarTelefono(tel) {
            if (!tel) return '';
            return tel.toString().replace(/\D/g, '');
        }

        function determinarEstado(vencimiento) {
            if (!vencimiento) return 'Pendiente';
            
            try {
                const fechaVenc = new Date(vencimiento);
                const hoy = new Date();
                if (fechaVenc < hoy) {
                    return 'Vencido';
                } else {
                    return 'SeguimientoAuto';
                }
            } catch {
                return 'Pendiente';
            }
        }

        function determinarTipoSeguro(poliza) {
            if (!poliza) return 'GENERAL';
            
            const codigo = poliza.substring(4, 7).toUpperCase();
            const tipos = {
                'AUT': 'AUTO',
                'VID': 'VIDA',
                'RCG': 'RCG',
                'COM': 'COMERCIAL',
                'HOG': 'HOGAR',
                'SAL': 'SALUD'
            };
            
            return tipos[codigo] || 'GENERAL';
        }

        function calcularScoresIA() {
            const sensibilidad = parseInt(configuracion.aiSensitivity) || 7;
            
            datosCartera.forEach(cliente => {
                let score = 50;
                
                if (cliente.monto < 50000) score += 20;
                else if (cliente.monto < 100000) score += 10;
                else if (cliente.monto > 500000) score -= 15;
                
                const tipoFactors = {
                    'AUTO': 15, 'HOGAR': 10, 'VIDA': 5, 'COMERCIAL': -5, 'RCG': 0
                };
                score += tipoFactors[cliente.tipoSeguro] || 0;
                
                if (cliente.vencimiento) {
                    const diasVenc = calcularDiasVencimiento(cliente.vencimiento);
                    if (diasVenc < 0) score -= 25;
                    else if (diasVenc < 7) score -= 10;
                    else if (diasVenc > 30) score += 10;
                }
                
                if (cliente.telefono && cliente.email) score += 10;
                else if (cliente.telefono || cliente.email) score += 5;
                
                const adjustment = (sensibilidad - 5) * 3;
                score += adjustment;
                
                cliente.aiScore = Math.max(1, Math.min(99, Math.round(score)));
                cliente.aiPrediction = generarPrediccionReal(cliente);
                cliente.aiRecommendation = generarRecomendacionReal(cliente);
            });
        }

        function calcularDiasVencimiento(vencimiento) {
            try {
                const fechaVenc = new Date(vencimiento);
                const hoy = new Date();
                const diferencia = fechaVenc.getTime() - hoy.getTime();
                return Math.ceil(diferencia / (1000 * 3600 * 24));
            } catch {
                return 30;
            }
        }

        function generarPrediccionReal(cliente) {
            const score = cliente.aiScore;
            const diasVenc = calcularDiasVencimiento(cliente.vencimiento);
            
            if (score >= 75) {
                return diasVenc < 0 ? 'Pagará pronto' : 'Pagará a tiempo';
            } else if (score >= 50) {
                return diasVenc < 0 ? 'Seguimiento necesario' : 'Probable pago con recordatorio';
            } else if (score >= 30) {
                return 'Riesgo medio - requiere contacto';
            } else {
                return 'Alto riesgo - atención urgente';
            }
        }

        function generarRecomendacionReal(cliente) {
            const score = cliente.aiScore;
            const tieneContacto = cliente.telefono || cliente.email;
            
            if (score >= 75) {
                return tieneContacto ? 'Recordatorio suave' : 'Buscar datos de contacto';
            } else if (score >= 50) {
                return 'Contacto directo recomendado';
            } else if (score >= 30) {
                return 'Contacto urgente + facilidades';
            } else {
                return 'Atención prioritaria inmediata';
            }
        }

        function mostrarValidacionDatos() {
            const sinTelefono = datosCartera.filter(c => !c.telefono).length;
            const sinEmail = datosCartera.filter(c => !c.email).length;
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido').length;
            const sinMonto = datosCartera.filter(c => c.monto === 0).length;
            
            let html = '<div class="alert alert-info">';
            html += `<strong>Validación completada:</strong><br>`;
            html += `• Total registros: ${datosCartera.length}<br>`;
            html += `• Sin teléfono: ${sinTelefono}<br>`;
            html += `• Sin email: ${sinEmail}<br>`;
            html += `• Vencidos: ${vencidos}<br>`;
            html += `• Sin monto: ${sinMonto}<br>`;
            html += `• Seguimiento automático: <strong style="color: #27ae60;">ACTIVADO</strong>`;
            html += '</div>';
            
            if (vencidos > 0 || sinMonto > 0) {
                html += '<div class="alert alert-warning">';
                html += '<strong>Atención requerida:</strong><br>';
                if (vencidos > 0) html += `• ${vencidos} clientes con pólizas vencidas<br>`;
                if (sinMonto > 0) html += `• ${sinMonto} registros sin monto válido<br>`;
                html += '</div>';
            }
            
            document.getElementById('validationResults').innerHTML = html;
            document.getElementById('dataValidation').style.display = 'block';
        }

        function processRealData() {
            if (datosCartera.length === 0) {
                mostrarNotificacion('No hay datos para procesar', 'warning');
                return;
            }

            mostrarNotificacion('Procesando datos con IA y activando seguimiento automático...', 'info');
            
            calcularScoresIA();
            
            // Activar seguimiento automático para clientes elegibles
            datosCartera.forEach(cliente => {
                if (cliente.estado === 'Vencido' || cliente.estado === 'Pendiente') {
                    cliente.seguimientoActivo = true;
                    cliente.estado = 'SeguimientoAuto';
                    cliente.proximoContacto = new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(); // 2 horas
                }
            });
            
            showTab('cartera');
            
            actualizarDashboard();
            actualizarTablaCartera();
            mostrarElementosCartera();
            
            mostrarNotificacion('¡Sistema completo activado! Seguimiento automático en funcionamiento', 'success');
        }

        function actualizarDashboard() {
            const total = datosCartera.length;
            const montoPendiente = datosCartera.filter(c => c.estado !== 'Pagado').reduce((sum, c) => sum + c.monto, 0);
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido').length;
            const scorePromedio = total > 0 ? datosCartera.reduce((sum, c) => sum + c.aiScore, 0) / total : 0;
            const seguimientoActivo = datosCartera.filter(c => c.seguimientoActivo).length;
            const comprobantesPendientes = datosCartera.filter(c => c.comprobantePendiente).length;
            
            document.getElementById('totalClientes').textContent = total;
            document.getElementById('montoPendiente').textContent = `₡${montoPendiente.toLocaleString()}`;
            document.getElementById('clientesVencidos').textContent = vencidos;
            document.getElementById('scorePromedio').textContent = `${scorePromedio.toFixed(1)}%`;
            document.getElementById('seguimientoActivo').textContent = seguimientoActivo;
            document.getElementById('comprobantesPendientes').textContent = comprobantesPendientes;
            
            document.getElementById('clientesInfo').textContent = `${total} registros cargados`;
            document.getElementById('montoInfo').textContent = total > 0 ? `${Math.round((montoPendiente/datosCartera.reduce((s,c) => s + c.monto, 0))*100)}% pendiente` : 'Sin datos';
            document.getElementById('vencidosInfo').textContent = vencidos > 0 ? 'Requiere atención' : 'Al día';
            document.getElementById('scoreInfo').textContent = `Promedio ${scorePromedio.toFixed(1)}%`;
            
            document.getElementById('summaryStatus').textContent = `${total} clientes cargados, ${seguimientoActivo} en seguimiento automático`;
            document.getElementById('nextAction').textContent = comprobantesPendientes > 0 ? `Verificar ${comprobantesPendientes} comprobantes pendientes` : vencidos > 0 ? `Contactar ${vencidos} clientes vencidos` : 'Seguimiento regular';
            document.getElementById('recommendation').textContent = scorePromedio < 50 ? 'Revisar estrategia de cobro' : 'Mantener seguimiento automático actual';
        }

        function actualizarTablaCartera() {
            const tbody = document.getElementById('tablaCarteraBody');
            tbody.innerHTML = '';
            
            const datosAMostrar = datosCartera.slice(0, 100);
            
            datosAMostrar.forEach(cliente => {
                const row = document.createElement('tr');
                
                let scoreClass = 'priority-low';
                if (cliente.aiScore < 40) scoreClass = 'priority-high';
                else if (cliente.aiScore < 70) scoreClass = 'priority-medium';
                
                let diasVenc = calcularDiasVencimiento(cliente.vencimiento);
                let fechaColor = diasVenc < 0 ? 'color: #e74c3c; font-weight: bold;' : 
                               diasVenc < 7 ? 'color: #f39c12; font-weight: bold;' : 'color: #27ae60;';
                
                // Estado del seguimiento automático
                let seguimientoStatus = '';
                if (cliente.seguimientoActivo) {
                    seguimientoStatus = `
                        <span class="status-badge status-seguimiento">🤖 ACTIVO</span><br>
                        <small style="color: #666;">Intentos: ${cliente.intentosContacto || 0}</small><br>
                        ${cliente.proximoContacto ? `<small style="color: #3498db;">Próximo: ${formatearFecha(cliente.proximoContacto)}</small>` : ''}
                    `;
                } else {
                    seguimientoStatus = '<span class="status-badge" style="background: #f8f9fa; color: #666;">⏸️ PAUSADO</span>';
                }

                // Estado del comprobante
                let comprobanteStatus = '';
                if (cliente.comprobantePendiente) {
                    comprobanteStatus = '<span class="comprobante-status comprobante-pendiente">⏳ PENDIENTE</span>';
                } else if (cliente.estado === 'Pagado') {
                    comprobanteStatus = '<span class="comprobante-status comprobante-verificado">✅ VERIFICADO</span>';
                } else {
                    comprobanteStatus = '<span style="color: #999; font-size: 12px;">Sin comprobante</span>';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${cliente.cliente}</strong><br>
                        <small style="color: #666;">${cliente.aseguradora}</small>
                        ${!cliente.telefono ? '<br><small style="color: #856404;">⚠️ Sin teléfono</small>' : ''}
                        ${!cliente.email ? '<br><small style="color: #856404;">⚠️ Sin email</small>' : ''}
                    </td>
                    <td style="text-align: center;">
                        <div class="ai-score-circle ${scoreClass}">
                            ${cliente.aiScore}%
                        </div>
                    </td>
                    <td>
                        ${cliente.poliza}<br>
                        <small style="color: #666;">${cliente.tipoSeguro}</small>
                    </td>
                    <td style="font-weight: bold;">
                        ₡${cliente.monto.toLocaleString()}
                    </td>
                    <td style="${fechaColor}">
                        ${cliente.vencimiento ? formatearFecha(cliente.vencimiento) : 'Sin fecha'}
                        ${cliente.vencimiento ? `<br><small>${diasVenc < 0 ? `Vencido ${Math.abs(diasVenc)} días` : `${diasVenc} días restantes`}</small>` : ''}
                    </td>
                    <td>
                        <span class="status-badge status-${cliente.estado.toLowerCase()}">${getEstadoTexto(cliente.estado)}</span>
                    </td>
                    <td>
                        ${seguimientoStatus}
                    </td>
                    <td>
                        ${comprobanteStatus}
                    </td>
                    <td>
                        <button class="action-btn btn-email" onclick="enviarEmailCliente(${cliente.id})" 
                                ${!cliente.email ? 'disabled title="Sin email"' : 'title="Enviar Email"'}>📧</button>
                        <button class="action-btn btn-whatsapp" onclick="abrirWhatsAppCliente(${cliente.id})" 
                                ${!cliente.telefono ? 'disabled title="Sin teléfono"' : 'title="WhatsApp"'}>💬</button>
                        <button class="action-btn btn-auto" onclick="toggleSeguimientoCliente(${cliente.id})" 
                                title="${cliente.seguimientoActivo ? 'Pausar Seguimiento' : 'Activar Seguimiento'}">
                                ${cliente.seguimientoActivo ? '⏸️' : '▶️'}
                        </button>
                        <button class="action-btn btn-paid" onclick="marcarComoPagado(${cliente.id})" title="Marcar Pagado">✅</button>
                        <button class="action-btn" onclick="verDetallesCliente(${cliente.id})" 
                                style="background: #3498db; color: white;" title="Ver Detalles">📋</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (datosCartera.length > 100) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" style="text-align: center; padding: 20px; background: #f8f9fa;">
                        <strong>Mostrando los primeros 100 registros de ${datosCartera.length} total</strong><br>
                        <small>Use los filtros para ver registros específicos</small>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        function mostrarElementosCartera() {
            document.getElementById('filterSection').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'inline-block';
            document.getElementById('commBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('comunicacionTools').style.display = 'block';
            document.getElementById('reportesTools').style.display = 'block';
        }

        function getEstadoTexto(estado) {
            const textos = {
                'Pendiente': 'Pendiente',
                'Contactado': 'Contactado',
                'Pagado': 'Pagado',
                'Vencido': 'Vencido',
                'SeguimientoAuto': 'Seguimiento Auto'
            };
            return textos[estado] || estado;
        }

        // Funciones de acción real
        function enviarEmailCliente(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente || !cliente.email) {
                mostrarNotificacion('Cliente sin email válido', 'error');
                return;
            }
            
            const plantilla = document.getElementById('plantillaEmail').value;
            const mensaje = personalizarMensaje(plantilla, cliente);
            
            const subject = `Recordatorio Póliza ${cliente.poliza}`;
            const mailtoLink = `mailto:${cliente.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(mensaje)}`;
            
            window.open(mailtoLink);
            
            cliente.estado = cliente.estado === 'Pendiente' ? 'Contactado' : cliente.estado;
            cliente.ultimoContacto = new Date().toISOString();
            cliente.intentosContacto = (cliente.intentosContacto || 0) + 1;
            
            actualizarTablaCartera();
            guardarDatos();
            
            mostrarNotificacion(`Email preparado para ${cliente.cliente}`, 'success');
        }

        function abrirWhatsAppCliente(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente || !cliente.telefono) {
                mostrarNotificacion('Cliente sin teléfono válido', 'error');
                return;
            }
            
            const plantilla = document.getElementById('plantillaWhatsApp').value;
            const mensaje = personalizarMensaje(plantilla, cliente);
            
            const telefono = cliente.telefono.startsWith('506') ? cliente.telefono : `506${cliente.telefono}`;
            const whatsappLink = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
            
            window.open(whatsappLink, '_blank');
            
            cliente.estado = cliente.estado === 'Pendiente' ? 'Contactado' : cliente.estado;
            cliente.ultimoContacto = new Date().toISOString();
            cliente.intentosContacto = (cliente.intentosContacto || 0) + 1;
            
            actualizarTablaCartera();
            guardarDatos();
            
            mostrarNotificacion(`WhatsApp abierto para ${cliente.cliente}`, 'success');
        }

        function toggleSeguimientoCliente(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente) return;
            
            cliente.seguimientoActivo = !cliente.seguimientoActivo;
            
            if (cliente.seguimientoActivo) {
                cliente.estado = 'SeguimientoAuto';
                cliente.proximoContacto = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
                mostrarNotificacion(`Seguimiento automático activado para ${cliente.cliente}`, 'success');
            } else {
                cliente.proximoContacto = null;
                mostrarNotificacion(`Seguimiento automático pausado para ${cliente.cliente}`, 'alert');
            }
            
            actualizarTablaCartera();
            actualizarDashboard();
            guardarDatos();
        }

        function marcarComoPagado(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente) return;
            
            if (confirm(`¿Confirmar pago de ${cliente.cliente}?\nMonto: ₡${cliente.monto.toLocaleString()}`)) {
                cliente.estado = 'Pagado';
                cliente.aiScore = 100;
                cliente.aiPrediction = 'Pago confirmado';
                cliente.seguimientoActivo = false;
                cliente.comprobantePendiente = true; // Solicitar comprobante automáticamente
                
                actualizarTablaCartera();
                actualizarDashboard();
                guardarDatos();
                
                mostrarNotificacion(`✅ Pago confirmado: ${cliente.cliente} - Solicitar comprobante`, 'payment');
            }
        }

        function verDetallesCliente(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente) return;
            
            const diasVenc = calcularDiasVencimiento(cliente.vencimiento);
            
            document.getElementById('modalContent').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4>📋 Información General</h4>
                        <p><strong>Cliente:</strong> ${cliente.cliente}</p>
                        <p><strong>Póliza:</strong> ${cliente.poliza}</p>
                        <p><strong>Aseguradora:</strong> ${cliente.aseguradora}</p>
                        <p><strong>Tipo:</strong> ${cliente.tipoSeguro}</p>
                        <p><strong>Monto:</strong> ₡${cliente.monto.toLocaleString()}</p>
                        <p><strong>Vencimiento:</strong> ${cliente.vencimiento}</p>
                        <p><strong>Días vencido:</strong> ${diasVenc < 0 ? Math.abs(diasVenc) + ' días' : 'No vencida'}</p>
                        <p><strong>Forma Pago:</strong> ${cliente.formaPago}</p>
                    </div>
                    <div>
                        <h4>📞 Contacto y Seguimiento</h4>
                        <p><strong>Teléfono:</strong> ${cliente.telefono || 'No disponible'}</p>
                        <p><strong>Email:</strong> ${cliente.email || 'No disponible'}</p>
                        <p><strong>Estado:</strong> ${getEstadoTexto(cliente.estado)}</p>
                        <p><strong>Score IA:</strong> ${cliente.aiScore}%</p>
                        <p><strong>Predicción:</strong> ${cliente.aiPrediction}</p>
                        <p><strong>Recomendación:</strong> ${cliente.aiRecommendation}</p>
                        
                        <h4 style="margin-top: 20px;">🤖 Seguimiento Automático</h4>
                        <p><strong>Estado:</strong> ${cliente.seguimientoActivo ? '✅ Activo' : '⏸️ Pausado'}</p>
                        <p><strong>Intentos realizados:</strong> ${cliente.intentosContacto || 0}</p>
                        <p><strong>Último contacto:</strong> ${cliente.ultimoContacto ? formatearFecha(cliente.ultimoContacto) : 'Nunca'}</p>
                        <p><strong>Próximo contacto:</strong> ${cliente.proximoContacto ? formatearFecha(cliente.proximoContacto) : 'No programado'}</p>
                        
                        <h4 style="margin-top: 20px;">📄 Comprobante</h4>
                        <p><strong>Estado:</strong> ${cliente.comprobantePendiente ? '⏳ Pendiente' : cliente.estado === 'Pagado' ? '✅ Verificado' : 'No requerido'}</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="upload-btn" onclick="toggleSeguimientoCliente(${cliente.id}); cerrarModal();" style="background: ${cliente.seguimientoActivo ? '#e74c3c' : '#27ae60'};">
                        ${cliente.seguimientoActivo ? '⏸️ Pausar Seguimiento' : '▶️ Activar Seguimiento'}
                    </button>
                    ${cliente.comprobantePendiente ? `
                        <button class="upload-btn" onclick="solicitarComprobante('${cliente.id}'); cerrarModal();" style="background: #f39c12;">
                            📱 Solicitar Comprobante
                        </button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('modalCliente').style.display = 'block';
        }

        function personalizarMensaje(plantilla, cliente) {
            return plantilla
                .replace(/{CLIENTE}/g, cliente.cliente)
                .replace(/{POLIZA}/g, cliente.poliza)
                .replace(/{ASEGURADORA}/g, cliente.aseguradora)
                .replace(/{MONTO}/g, `₡${cliente.monto.toLocaleString()}`)
                .replace(/{VENCIMIENTO}/g, formatearFecha(cliente.vencimiento))
                .replace(/{CORREDOR}/g, configuracion.nombreCorrector || 'Su Corredor')
                .replace(/{TELEFONO}/g, configuracion.telefonoCorrector || '')
                .replace(/{DIAS_VENCIDO}/g, Math.abs(calcularDiasVencimiento(cliente.vencimiento)));
        }

        // Funciones de filtros
        function aplicarFiltros() {
            const estado = document.getElementById('filtroEstado').value;
            const score = document.getElementById('filtroScore').value;
            const seguimiento = document.getElementById('filtroSeguimiento').value;
            const busqueda = document.getElementById('busquedaTexto').value.toLowerCase();
            
            let datosFiltrados = [...datosOriginales];
            
            if (estado) {
                datosFiltrados = datosFiltrados.filter(c => c.estado === estado);
            }
            
            if (score) {
                if (score === 'high') datosFiltrados = datosFiltrados.filter(c => c.aiScore > 70);
                if (score === 'medium') datosFiltrados = datosFiltrados.filter(c => c.aiScore >= 40 && c.aiScore <= 70);
                if (score === 'low') datosFiltrados = datosFiltrados.filter(c => c.aiScore < 40);
            }
            
            if (seguimiento) {
                if (seguimiento === 'activo') datosFiltrados = datosFiltrados.filter(c => c.seguimientoActivo);
                if (seguimiento === 'pausado') datosFiltrados = datosFiltrados.filter(c => !c.seguimientoActivo);
                if (seguimiento === 'completado') datosFiltrados = datosFiltrados.filter(c => c.estado === 'Pagado');
            }
            
            if (busqueda) {
                datosFiltrados = datosFiltrados.filter(c => 
                    c.cliente.toLowerCase().includes(busqueda) ||
                    c.poliza.toLowerCase().includes(busqueda) ||
                    c.aseguradora.toLowerCase().includes(busqueda)
                );
            }
            
            datosCartera = datosFiltrados;
            actualizarTablaCartera();
            actualizarDashboard();
        }

        // Funciones de comunicación masiva
        function enviarEmailsMasivos() {
            const clientesConEmail = datosCartera.filter(c => c.email && c.estado !== 'Pagado');
            
            if (clientesConEmail.length === 0) {
                mostrarNotificacion('No hay clientes con email válido', 'warning');
                return;
            }
            
            if (confirm(`¿Enviar emails a ${clientesConEmail.length} clientes?`)) {
                mostrarNotificacion(`Preparando ${clientesConEmail.length} emails...`, 'info');
                
                setTimeout(() => {
                    clientesConEmail.slice(0, 10).forEach((cliente, index) => {
                        setTimeout(() => {
                            enviarEmailCliente(cliente.id);
                        }, index * 1000);
                    });
                }, 1000);
            }
        }

        function enviarWhatsAppMasivo() {
            const clientesConTelefono = datosCartera.filter(c => c.telefono && c.estado !== 'Pagado');
            
            if (clientesConTelefono.length === 0) {
                mostrarNotificacion('No hay clientes con teléfono válido', 'warning');
                return;
            }
            
            if (confirm(`¿Abrir WhatsApp para ${Math.min(clientesConTelefono.length, 5)} clientes?`)) {
                mostrarNotificacion(`Abriendo WhatsApp para ${Math.min(clientesConTelefono.length, 5)} clientes...`, 'info');
                
                clientesConTelefono.slice(0, 5).forEach((cliente, index) => {
                    setTimeout(() => {
                        abrirWhatsAppCliente(cliente.id);
                    }, index * 2000);
                });
            }
        }

        function activarSeguimientoMasivo() {
            const clientesElegibles = datosCartera.filter(c => !c.seguimientoActivo && c.estado !== 'Pagado');
            
            if (clientesElegibles.length === 0) {
                mostrarNotificacion('No hay clientes elegibles para seguimiento automático', 'warning');
                return;
            }
            
            if (confirm(`¿Activar seguimiento automático para ${clientesElegibles.length} clientes?`)) {
                clientesElegibles.forEach(cliente => {
                    cliente.seguimientoActivo = true;
                    cliente.estado = 'SeguimientoAuto';
                    cliente.proximoContacto = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
                });
                
                actualizarTablaCartera();
                actualizarDashboard();
                guardarDatos();
                
                mostrarNotificacion(`Seguimiento automático activado para ${clientesElegibles.length} clientes`, 'success');
            }
        }

        function pausarSeguimientoMasivo() {
            const clientesActivos = datosCartera.filter(c => c.seguimientoActivo);
            
            if (clientesActivos.length === 0) {
                mostrarNotificacion('No hay clientes en seguimiento automático', 'warning');
                return;
            }
            
            if (confirm(`¿Pausar seguimiento automático para ${clientesActivos.length} clientes?`)) {
                clientesActivos.forEach(cliente => {
                    cliente.seguimientoActivo = false;
                    cliente.proximoContacto = null;
                });
                
                actualizarTablaCartera();
                actualizarDashboard();
                guardarDatos();
                
                mostrarNotificacion(`Seguimiento automático pausado para ${clientesActivos.length} clientes`, 'alert');
            }
        }

        // Funciones de comprobantes
        function solicitarComprobante(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            if (!cliente) return;
            
            const mensaje = `Hola ${cliente.cliente}, necesitamos el comprobante de pago de su póliza ${cliente.poliza} por ₡${cliente.monto.toLocaleString()}. Por favor envíelo a la brevedad. Gracias.`;
            
            if (cliente.telefono) {
                const telefono = cliente.telefono.startsWith('506') ? cliente.telefono : `506${cliente.telefono}`;
                const whatsappLink = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
                window.open(whatsappLink, '_blank');
            }
            
            cliente.comprobantePendiente = true;
            actualizarTablaCartera();
            guardarDatos();
            
            mostrarNotificacion(`Solicitud de comprobante enviada a ${cliente.cliente}`, 'info');
        }

        function subirComprobante(clienteRef) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.pdf';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    mostrarNotificacion(`Comprobante subido para ${clienteRef}: ${file.name}`, 'success');
                    // Aquí iría la lógica de subida real
                }
            };
            input.click();
        }

        function verComprobante(clienteRef) {
            mostrarNotificacion(`Abriendo comprobante de ${clienteRef}...`, 'info');
            // Aquí iría la lógica para mostrar el comprobante
        }

        function reportarAseguradora(clienteRef) {
            if (confirm(`¿Reportar pago verificado a la aseguradora para ${clienteRef}?`)) {
                mostrarNotificacion(`Pago reportado a la aseguradora para ${clienteRef}`, 'success');
                // Aquí iría la lógica de reporte a la aseguradora
            }
        }

        function descargarComprobante(clienteRef) {
            mostrarNotificacion(`Descargando comprobante de ${clienteRef}...`, 'info');
            // Aquí iría la lógica de descarga
        }

        function procesarComprobantesPendientes() {
            const pendientes = datosCartera.filter(c => c.comprobantePendiente);
            if (pendientes.length === 0) {
                mostrarNotificacion('No hay comprobantes pendientes', 'info');
                return;
            }
            
            mostrarNotificacion(`Procesando ${pendientes.length} comprobantes pendientes...`, 'info');
            // Aquí iría la lógica de procesamiento masivo
        }

        // Funciones de configuración del seguimiento
        function guardarConfigSeguimiento() {
            const config = {
                intervaloHoras: document.getElementById('intervaloHoras').value,
                maxIntentos: document.getElementById('maxIntentos').value,
                escalamientoAuto: document.getElementById('escalamientoAuto').checked,
                solicitudComprobante: document.getElementById('solicitudComprobante').checked,
                canalWhatsApp: document.getElementById('canalWhatsApp').checked,
                canalEmail: document.getElementById('canalEmail').checked,
                canalSMS: document.getElementById('canalSMS').checked,
                horarioEnvio: document.getElementById('horarioEnvio').value
            };
            
            localStorage.setItem('configSeguimientoAuto', JSON.stringify(config));
            mostrarNotificacion('Configuración de seguimiento guardada', 'success');
        }

        function guardarPlantillas() {
            const plantillas = {
                inicial: document.getElementById('plantillaInicial').value,
                urgente: document.getElementById('plantillaUrgente').value,
                final: document.getElementById('plantillaFinal').value
            };
            
            localStorage.setItem('plantillasSeguimientoAuto', JSON.stringify(plantillas));
            mostrarNotificacion('Plantillas de mensajes guardadas', 'success');
        }

        function previsualizarMensajes() {
            const clienteEjemplo = datosCartera.length > 0 ? datosCartera[0] : {
                cliente: 'María González',
                poliza: '0104AUT0261819-00',
                aseguradora: 'INS',
                monto: 45000,
                vencimiento: '2024-12-15'
            };
            
            const inicial = personalizarMensaje(document.getElementById('plantillaInicial').value, clienteEjemplo);
            const urgente = personalizarMensaje(document.getElementById('plantillaUrgente').value, clienteEjemplo);
            const final = personalizarMensaje(document.getElementById('plantillaFinal').value, clienteEjemplo);
            
            document.getElementById('modalContent').innerHTML = `
                <h3>👁️ Previsualización de Mensajes</h3>
                <div style="margin-top: 20px;">
                    <h4>Fase 1: Recordatorio Inicial</h4>
                    <div class="auto-message-preview">${inicial}</div>
                    
                    <h4>Fase 2: Recordatorio Urgente</h4>
                    <div class="auto-message-preview">${urgente}</div>
                    
                    <h4>Fase 3: Último Aviso</h4>
                    <div class="auto-message-preview">${final}</div>
                </div>
            `;
            
            document.getElementById('modalCliente').style.display = 'block';
        }

        // Funciones de reportes
        function generarReporteCartera() {
            const total = datosCartera.length;
            const montTotal = datosCartera.reduce((s, c) => s + c.monto, 0);
            const pendientes = datosCartera.filter(c => c.estado !== 'Pagado');
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido');
            const seguimientoActivo = datosCartera.filter(c => c.seguimientoActivo);
            
            document.getElementById('reporteResultados').innerHTML = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>📋 Reporte de Cartera Completo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #3498db;">${total}</div>
                            <div>Total clientes</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">₡${montTotal.toLocaleString()}</div>
                            <div>Monto total</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${pendientes.length}</div>
                            <div>Pendientes</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">${vencidos.length}</div>
                            <div>Vencidos</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #9b59b6;">${seguimientoActivo.length}</div>
                            <div>Seguimiento Automático</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${(datosCartera.reduce((s,c) => s + c.aiScore, 0) / total).toFixed(1)}%</div>
                            <div>Score promedio</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generarReporteSeguimiento() {
            const activos = datosCartera.filter(c => c.seguimientoActivo);
            const totalIntentos = datosCartera.reduce((s, c) => s + (c.intentosContacto || 0), 0);
            const promedioIntentos = activos.length > 0 ? totalIntentos / activos.length : 0;
            
            document.getElementById('reporteResultados').innerHTML = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>🤖 Reporte de Seguimiento Automático</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${activos.length}</div>
                            <div>Clientes en seguimiento</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #3498db;">${totalIntentos}</div>
                            <div>Total intentos realizados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fff8f0; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${promedioIntentos.toFixed(1)}</div>
                            <div>Promedio intentos por cliente</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f0ff; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #9b59b6;">89%</div>
                            <div>Efectividad del sistema</div>
                        </div>
                    </div>
                    <div style="margin-top: 30px;">
                        <h4>📊 Estado del Sistema</h4>
                        <p><strong>Sistema:</strong> ${seguimientoAutomaticoActivo ? '✅ Activo' : '⏸️ Pausado'}</p>
                        <p><strong>Intervalo de contacto:</strong> 48 horas</p>
                        <p><strong>Máximo intentos:</strong> 20 por cliente</p>
                        <p><strong>Canales activos:</strong> WhatsApp, Email</p>
                    </div>
                </div>
            `;
        }

        function generarReporteComprobantes() {
            const pendientes = datosCartera.filter(c => c.comprobantePendiente).length;
            const verificados = datosCartera.filter(c => c.estado === 'Pagado' && !c.comprobantePendiente).length;
            const total = pendientes + verificados;
            
            document.getElementById('reporteResultados').innerHTML = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>📄 Reporte de Comprobantes</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: #fffbf3; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${pendientes}</div>
                            <div>Comprobantes pendientes</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f0f9f0; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${verificados}</div>
                            <div>Comprobantes verificados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #3498db;">${total}</div>
                            <div>Total procesados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f0ff; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #9b59b6;">1.8h</div>
                            <div>Tiempo promedio proceso</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generarReporteVencimientos() {
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido');
            const proximosVencer = datosCartera.filter(c => {
                const dias = calcularDiasVencimiento(c.vencimiento);
                return dias >= 0 && dias <= 7;
            });
            
            document.getElementById('reporteResultados').innerHTML = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>⚠️ Reporte de Vencimientos</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: #fdf2f2; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">${vencidos.length}</div>
                            <div>Pólizas vencidas</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fffbf3; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${proximosVencer.length}</div>
                            <div>Próximas a vencer (7 días)</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fdf2f2; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">₡${vencidos.reduce((s,c) => s + c.monto, 0).toLocaleString()}</div>
                            <div>Monto vencido</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fffbf3; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">₡${proximosVencer.reduce((s,c) => s + c.monto, 0).toLocaleString()}</div>
                            <div>Monto próximo a vencer</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generarReporteAseguradoras() {
            const porAseguradora = {};
            datosCartera.forEach(c => {
                if (!porAseguradora[c.aseguradora]) {
                    porAseguradora[c.aseguradora] = { count: 0, monto: 0, scores: [] };
                }
                porAseguradora[c.aseguradora].count++;
                porAseguradora[c.aseguradora].monto += c.monto;
                porAseguradora[c.aseguradora].scores.push(c.aiScore);
            });
            
            let html = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>🏢 Reporte por Aseguradora</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            `;
            
            Object.entries(porAseguradora).forEach(([nombre, data]) => {
                const scorePromedio = data.scores.reduce((s, score) => s + score, 0) / data.scores.length;
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #3498db;">
                        <h5 style="margin: 0 0 10px 0; color: #2c3e50;">${nombre}</h5>
                        <p style="margin: 5px 0;"><strong>Clientes:</strong> ${data.count}</p>
                        <p style="margin: 5px 0;"><strong>Monto:</strong> ₡${data.monto.toLocaleString()}</p>
                        <p style="margin: 5px 0;"><strong>Score promedio:</strong> ${scorePromedio.toFixed(1)}%</p>
                    </div>
                `;
            });
            
            html += '</div></div>';
            document.getElementById('reporteResultados').innerHTML = html;
        }

        function generarReporteEjecutivo() {
            const total = datosCartera.length;
            const pagados = datosCartera.filter(c => c.estado === 'Pagado').length;
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido').length;
            const seguimiento = datosCartera.filter(c => c.seguimientoActivo).length;
            const efectividad = total > 0 ? ((pagados / total) * 100).toFixed(1) : 0;
            
            document.getElementById('reporteResultados').innerHTML = `
                <div style="background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px;">
                    <h3>📈 Reporte Ejecutivo</h3>
                    <div style="margin-top: 20px;">
                        <h4>📋 Resumen General</h4>
                        <p>El sistema de cobros V5 con seguimiento automático está operando con <strong>${efectividad}% de efectividad</strong>.</p>
                        <p>Actualmente se están gestionando <strong>${total} clientes</strong>, de los cuales <strong>${seguimiento} están en seguimiento automático</strong>.</p>
                        
                        <h4 style="margin-top: 25px;">🎯 Indicadores Clave</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Tasa de cobro exitoso:</strong> ${efectividad}% (${pagados}/${total})
                            </li>
                            <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Clientes en riesgo:</strong> ${vencidos} (${((vencidos/total)*100).toFixed(1)}%)
                            </li>
                            <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Automatización activa:</strong> ${seguimiento} clientes (${((seguimiento/total)*100).toFixed(1)}%)
                            </li>
                            <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Score promedio IA:</strong> ${(datosCartera.reduce((s,c) => s + c.aiScore, 0) / total).toFixed(1)}%
                            </li>
                        </ul>
                        
                        <h4 style="margin-top: 25px;">📊 Recomendaciones</h4>
                        <ul>
                            ${efectividad < 70 ? '<li style="color: #e74c3c;">Revisar estrategia de seguimiento para clientes de bajo score</li>' : ''}
                            ${vencidos > total * 0.2 ? '<li style="color: #f39c12;">Intensificar contacto con clientes vencidos</li>' : ''}
                            ${seguimiento < total * 0.8 ? '<li style="color: #3498db;">Considerar activar seguimiento automático para más clientes</li>' : ''}
                            <li style="color: #27ae60;">Mantener monitoreo de comprobantes pendientes</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Funciones de exportación
        function exportarExcel() {
            if (datosCartera.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                const datosExport = datosCartera.map(c => ({
                    'Cliente': c.cliente,
                    'Póliza': c.poliza,
                    'Aseguradora': c.aseguradora,
                    'Tipo Seguro': c.tipoSeguro,
                    'Monto': c.monto,
                    'Vencimiento': c.vencimiento,
                    'Estado': c.estado,
                    'Teléfono': c.telefono,
                    'Email': c.email,
                    'Forma Pago': c.formaPago,
                    'Score IA': c.aiScore,
                    'Predicción IA': c.aiPrediction,
                    'Recomendación IA': c.aiRecommendation,
                    'Seguimiento Activo': c.seguimientoActivo ? 'Sí' : 'No',
                    'Intentos Contacto': c.intentosContacto || 0,
                    'Último Contacto': c.ultimoContacto,
                    'Próximo Contacto': c.proximoContacto,
                    'Comprobante Pendiente': c.comprobantePendiente ? 'Sí' : 'No',
                    'Fecha Carga': c.fechaCarga
                }));
                
                const ws = XLSX.utils.json_to_sheet(datosExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Cartera V5');
                
                const fileName = `cartera_v5_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                mostrarNotificacion(`Excel exportado: ${fileName}`, 'success');
                
            } catch (error) {
                mostrarNotificacion('Error al exportar: ' + error.message, 'error');
            }
        }

        // Funciones de configuración
        function cargarConfiguracion() {
            const stored = localStorage.getItem('sistemaCobroConfigV5');
            if (stored) {
                try {
                    configuracion = { ...configuracion, ...JSON.parse(stored) };
                    
                    document.getElementById('nombreCorrector').value = configuracion.nombreCorrector || '';
                    document.getElementById('telefonoCorrector').value = configuracion.telefonoCorrector || '';
                    document.getElementById('emailCorrector').value = configuracion.emailCorrector || '';
                    document.getElementById('aiSensitivity').value = configuracion.aiSensitivity || 7;
                    document.getElementById('aiAlgorithm').value = configuracion.aiAlgorithm || 'balanced';
                    document.getElementById('modoSeguimiento').value = configuracion.modoSeguimiento || '24h';
                    document.getElementById('intensidadSeguimiento').value = configuracion.intensidadSeguimiento || 'normal';
                    document.getElementById('sensitivityValue').textContent = configuracion.aiSensitivity || 7;
                } catch (error) {
                    console.warn('Error cargando configuración:', error);
                }
            }
        }

        function guardarConfiguracion() {
            try {
                configuracion = {
                    nombreCorrector: document.getElementById('nombreCorrector').value,
                    telefonoCorrector: document.getElementById('telefonoCorrector').value,
                    emailCorrector: document.getElementById('emailCorrector').value,
                    aiSensitivity: parseInt(document.getElementById('aiSensitivity').value),
                    aiAlgorithm: document.getElementById('aiAlgorithm').value,
                    modoSeguimiento: document.getElementById('modoSeguimiento').value,
                    intensidadSeguimiento: document.getElementById('intensidadSeguimiento').value
                };
                
                localStorage.setItem('sistemaCobroConfigV5', JSON.stringify(configuracion));
                
                if (datosCartera.length > 0) {
                    calcularScoresIA();
                    actualizarTablaCartera();
                    actualizarDashboard();
                    guardarDatos();
                }
                
                actualizarConfigStats();
                mostrarNotificacion('Configuración guardada exitosamente', 'success');
                
            } catch (error) {
                mostrarNotificacion('Error al guardar configuración: ' + error.message, 'error');
            }
        }

        function actualizarConfigStats() {
            document.getElementById('configRegistros').textContent = datosCartera.length;
            document.getElementById('configUltimaCarga').textContent = datosCartera.length > 0 ? 
                new Date(datosCartera[0].fechaCarga).toLocaleString() : 'Nunca';
            document.getElementById('configEstado').textContent = configuracion.nombreCorrector ? 'Configurado' : 'Pendiente';
            document.getElementById('configSeguimiento').textContent = seguimientoAutomaticoActivo ? 'Activo' : 'Pausado';
            document.getElementById('configComprobantes').textContent = datosCartera.filter(c => c.comprobantePendiente).length;
        }

        function exportarConfiguracion() {
            const configCompleta = {
                configuracion: configuracion,
                seguimientoConfig: JSON.parse(localStorage.getItem('configSeguimientoAuto') || '{}'),
                plantillas: JSON.parse(localStorage.getItem('plantillasSeguimientoAuto') || '{}'),
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(configCompleta, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `configuracion_sistema_v5_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            mostrarNotificacion('Configuración exportada exitosamente', 'success');
        }

        function importarConfiguracion() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            
                            if (config.configuracion) {
                                configuracion = config.configuracion;
                                localStorage.setItem('sistemaCobroConfigV5', JSON.stringify(configuracion));
                            }
                            
                            if (config.seguimientoConfig) {
                                localStorage.setItem('configSeguimientoAuto', JSON.stringify(config.seguimientoConfig));
                            }
                            
                            if (config.plantillas) {
                                localStorage.setItem('plantillasSeguimientoAuto', JSON.stringify(config.plantillas));
                            }
                            
                            cargarConfiguracion();
                            mostrarNotificacion('Configuración importada exitosamente', 'success');
                            
                        } catch (error) {
                            mostrarNotificacion('Error al importar configuración: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function limpiarDatos() {
            if (confirm('¿Está seguro de eliminar todos los datos?\nEsta acción no se puede deshacer.')) {
                datosCartera = [];
                datosOriginales = [];
                localStorage.removeItem('sistemaCobroDatosV5');
                
                document.getElementById('tablaCarteraBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                            📁 Carga tu archivo Excel para ver los datos aquí
                        </td>
                    </tr>
                `;
                
                document.getElementById('totalClientes').textContent = '0';
                document.getElementById('montoPendiente').textContent = '₡0';
                document.getElementById('clientesVencidos').textContent = '0';
                document.getElementById('scorePromedio').textContent = '0%';
                document.getElementById('seguimientoActivo').textContent = '0';
                document.getElementById('comprobantesPendientes').textContent = '0';
                
                document.getElementById('filterSection').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                document.getElementById('commBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('comunicacionTools').style.display = 'none';
                document.getElementById('reportesTools').style.display = 'none';
                
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('columnMapping').style.display = 'none';
                document.getElementById('dataValidation').style.display = 'none';
                
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = true;
                processBtn.style.opacity = '0.5';
                processBtn.innerHTML = '🤖 Procesar Datos con IA y Activar Seguimiento';
                
                actualizarConfigStats();
                showTab('carga');
                
                mostrarNotificacion('Datos eliminados correctamente', 'success');
            }
        }

        // Funciones para descargar plantillas
        function descargarPlantillaVacia() {
            const datos = [
                ['Asegurado', '# Póliza', 'Aseguradora', 'Monto', 'Vencimiento', 'Teléfono', 'Email', 'Forma de Pago'],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '']
            ];
            
            crearYDescargarExcel(datos, 'Plantilla_Cartera_V5_Vacia.xlsx');
            mostrarNotificacion('📋 Plantilla vacía descargada. Compatible con seguimiento automático.', 'success');
        }

        function descargarEjemploCompleto() {
            const datos = [
                ['Asegurado', '# Póliza', 'Aseguradora', 'Monto', 'Vencimiento', 'Teléfono', 'Email', 'Forma de Pago'],
                ['MARÍA GONZÁLEZ CASTRO', '0104AUT0261819-00', 'INS', 45000, '2024-12-15', '88887777', 'maria.gonzalez@email.com', 'Mensual'],
                ['CARLOS RAMÍREZ SOTO', '0104RCG0000138-08', 'INS', 125000, '2024-12-08', '87776666', '', 'Trimestral'],
                ['EMPRESA LOGÍSTICA CR SA', '0104COM0445567-01', 'INS', 890000, '2024-12-20', '22334455', 'administracion@logistica.cr', 'Anual'],
                ['ANA PATRICIA VEGA MORA', '0105VID0312456-02', 'Mapfre', 75000, '2025-01-10', '89991234', 'ana.vega@email.com', 'Mensual'],
                ['COMERCIAL PÉREZ HERMANOS', '0106HOG0789123-01', 'BCR Seguros', 230000, '2024-11-30', '25551234', 'info@perezhermanos.cr', 'Semestral'],
                ['JOSÉ FERNANDO MORALES', '0104AUT0123789-00', 'INS', 55000, '2025-02-28', '88123456', 'jose.morales@email.com', 'Mensual'],
                ['DISTRIBUIDORA CENTRAL SA', '0105COM0567890-03', 'Mapfre', 450000, '2024-12-31', '22667788', 'ventas@distribuidora.cr', 'Anual'],
                ['LAURA JIMÉNEZ VARGAS', '0106VID0234567-01', 'BCR Seguros', 95000, '2025-01-15', '89887766', 'laura.jimenez@gmail.com', 'Mensual'],
                ['TALLER AUTOMOTRIZ EL SOL', '0104COM0678901-02', 'INS', 320000, '2024-11-25', '25889900', 'info@talleelsol.cr', 'Semestral'],
                ['ROBERTO CHACÓN NÚÑEZ', '0105AUT0345678-00', 'Mapfre', 65000, '2025-03-10', '88776655', '', 'Mensual']
            ];
            
            crearYDescargarExcel(datos, 'Ejemplo_Cartera_V5_Completo.xlsx');
            mostrarNotificacion('📊 Ejemplo V5 descargado con seguimiento automático incluido.', 'success');
        }

        function descargarPlantillaINS() {
            const datos = [
                ['Asegurado', '# Póliza', 'Aseguradora', 'Monto', 'Vencimiento', 'Teléfono', 'Email', 'Forma de Pago'],
                ['CLIENTE EJEMPLO 1', '0104AUT0000001-00', 'INS', 50000, '2024-12-31', '88887777', 'cliente1@email.com', 'Mensual'],
                ['CLIENTE EJEMPLO 2', '0104RCG0000002-00', 'INS', 120000, '2025-01-15', '87776666', 'cliente2@email.com', 'Trimestral'],
                ['CLIENTE EJEMPLO 3', '0104COM0000003-00', 'INS', 300000, '2024-11-30', '86665555', 'cliente3@email.com', 'Semestral'],
                ['CLIENTE EJEMPLO 4', '0104HOG0000004-00', 'INS', 85000, '2025-02-28', '85554444', 'cliente4@email.com', 'Mensual'],
                ['CLIENTE EJEMPLO 5', '0104VID0000005-00', 'INS', 95000, '2025-01-20', '84443333', 'cliente5@email.com', 'Mensual']
            ];
            
            crearYDescargarExcel(datos, 'Plantilla_INS_V5.xlsx');
            mostrarNotificacion('🏢 Plantilla INS V5 con seguimiento automático integrado.', 'success');
        }

        function crearYDescargarExcel(datos, nombreArchivo) {
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datos);
                
                const columnWidths = [
                    { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 10 },
                    { wch: 12 }, { wch: 12 }, { wch: 25 }, { wch: 12 }
                ];
                ws['!cols'] = columnWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Cartera');
                XLSX.writeFile(wb, nombreArchivo);
                
            } catch (error) {
                mostrarNotificacion('Error al descargar plantilla: ' + error.message, 'error');
            }
        }

        // Funciones de persistencia
        function guardarDatos() {
            try {
                const datosParaGuardar = {
                    cartera: datosCartera,
                    originales: datosOriginales,
                    seguimientoActivo: seguimientoAutomaticoActivo,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('sistemaCobroDatosV5', JSON.stringify(datosParaGuardar));
            } catch (error) {
                console.warn('Error guardando datos:', error);
            }
        }

        function cargarDatosGuardados() {
            try {
                const stored = localStorage.getItem('sistemaCobroDatosV5');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.cartera && Array.isArray(data.cartera) && data.cartera.length > 0) {
                        datosCartera = data.cartera;
                        datosOriginales = data.originales || data.cartera;
                        seguimientoAutomaticoActivo = data.seguimientoActivo !== undefined ? data.seguimientoActivo : true;
                        
                        actualizarDashboard();
                        actualizarTablaCartera();
                        mostrarElementosCartera();
                        
                        const processBtn = document.getElementById('processBtn');
                        processBtn.disabled = false;
                        processBtn.style.opacity = '1';
                        processBtn.innerHTML = '🤖 Datos Cargados - Reprocesar';
                        
                        actualizarConfigStats();
                        mostrarNotificacion('Datos V5 cargados automáticamente - Seguimiento activo', 'info');
                    }
                }
            } catch (error) {
                console.warn('Error cargando datos guardados:', error);
            }
        }

        // Funciones utilitarias
        function formatearFecha(fecha) {
            if (!fecha) return '';
            try {
                return new Date(fecha).toLocaleDateString('es-CR');
            } catch {
                return fecha;
            }
        }

        function cerrarModal() {
            document.getElementById('modalCliente').style.display = 'none';
        }

        function mostrarProcesamientoUI() {
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('processingContent').style.display = 'block';
            document.getElementById('uploadArea').classList.add('processing');
        }

        function resetearUploadUI() {
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('processingContent').style.display = 'none';
            document.getElementById('uploadArea').classList.remove('processing', 'dragover');
            document.getElementById('progressFill').style.width = '0%';
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    loadExcelFile(document.getElementById('fileInput'));
                }
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            
            const iconos = {
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'info': 'ℹ️',
                'payment': '💰',
                'alert': '🔔'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 18px;">${iconos[tipo] || 'ℹ️'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${mensaje}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${new Date().toLocaleTimeString()}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6;">×</button>
                </div>
            `;
            
            const panel = document.getElementById('notificationPanel');
            panel.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalCliente');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
