ğŸ“ "LLAMAR" - Prefiere contacto telefÃ³nico

ğŸ¤– Sistema IA recomienda: [AI_RECOMMENDATION]

Saludos,
[CORREDOR] ğŸ˜Š</textarea>
                </div>
            </div>

            <div class="form-group">
                <h3>ğŸš€ Herramientas de EnvÃ­o</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="upload-btn" onclick="enviarEmailsIA()" style="background: #e74c3c;">
                        ğŸ“§ EnvÃ­o Email IA
                        <br><small>SelecciÃ³n automÃ¡tica</small>
                    </button>
                    <button class="upload-btn" onclick="enviarWhatsAppIA()" style="background: #25d366;">
                        ğŸ’¬ WhatsApp IA
                        <br><small>Horario optimizado</small>
                    </button>
                    <button class="upload-btn" onclick="campaniaCompleta()" style="background: #9b59b6;">
                        âœ¨ CampaÃ±a Completa
                        <br><small>Multi-canal inteligente</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Reportes -->
        <div id="reportes" class="tab-content">
            <h2>ğŸ“Š Centro de Reportes Inteligentes</h2>
            
            <div class="ai-insights">
                <h3>ğŸ¯ Insights Ejecutivos</h3>
                <div class="ai-card">
                    <h4>ğŸ“ˆ AnÃ¡lisis Predictivo Avanzado</h4>
                    <div>
                        <p>ğŸ’° <strong>ProyecciÃ³n 30 dÃ­as:</strong> Calculando...</p>
                        <p>ğŸ“Š <strong>Eficiencia:</strong> +40% vs mÃ©todo tradicional</p>
                        <p>ğŸ¯ <strong>Clientes crÃ­ticos:</strong> Identificando...</p>
                        <p>âš¡ <strong>RecomendaciÃ³n:</strong> Carga datos para anÃ¡lisis</p>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <button class="upload-btn" onclick="reporteEjecutivo()" style="background: #2c3e50; padding: 20px; height: auto;">
                    <div style="font-size: 18px; margin-bottom: 10px;">ğŸ‘”</div>
                    <div><strong>Reporte Ejecutivo</strong></div>
                    <small style="display: block; margin-top: 5px; opacity: 0.8;">Dashboard completo con KPIs</small>
                </button>
                
                <button class="upload-btn" onclick="analisisRentabilidad()" style="background: #27ae60; padding: 20px; height: auto;">
                    <div style="font-size: 18px; margin-bottom: 10px;">ğŸ’°</div>
                    <div><strong>AnÃ¡lisis Rentabilidad</strong></div>
                    <small style="display: block; margin-top: 5px; opacity: 0.8;">ROI por aseguradora</small>
                </button>
                
                <button class="upload-btn" onclick="prediccionFlujo()" style="background: #3498db; padding: 20px; height: auto;">
                    <div style="font-size: 18px; margin-bottom: 10px;">ğŸ“ˆ</div>
                    <div><strong>PredicciÃ³n Flujo</strong></div>
                    <small style="display: block; margin-top: 5px; opacity: 0.8;">ProyecciÃ³n 90 dÃ­as IA</small>
                </button>
            </div>

            <div id="reporteContainer">
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #666;">ğŸ“Š Centro de Reportes Inteligentes</h3>
                    <p style="color: #666;">Selecciona un tipo de reporte para generar anÃ¡lisis detallados</p>
                </div>
            </div>
        </div>

        <!-- Tab ConfiguraciÃ³n -->
        <div id="configuracion" class="tab-content">
            <h2>âš™ï¸ ConfiguraciÃ³n del Sistema</h2>
            
            <div class="form-group">
                <h3>ğŸ‘¤ InformaciÃ³n del Corredor</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label>Nombre Completo:</label>
                        <input type="text" class="form-control" id="nombreCorrector" placeholder="Su nombre completo">
                    </div>
                    <div>
                        <label>TelÃ©fono WhatsApp:</label>
                        <input type="text" class="form-control" id="telefonoCorrector" placeholder="8888-7777">
                    </div>
                    <div>
                        <label>Email Profesional:</label>
                        <input type="email" class="form-control" id="emailCorrector" placeholder="corredor@ejemplo.com">
                    </div>
                </div>
            </div>

            <div class="ai-insights">
                <h3>ğŸ¤– ConfiguraciÃ³n de Inteligencia Artificial</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label>ğŸ¯ Sensibilidad del Score IA:</label>
                        <input type="range" class="form-control" id="aiSensitivity" min="1" max="10" value="7" 
                               onchange="document.getElementById('sensitivityValue').textContent = this.value">
                        <small>Nivel: <span id="sensitivityValue">7</span>/10</small>
                    </div>

                    <div class="form-group">
                        <label>ğŸ§  Algoritmo de PredicciÃ³n:</label>
                        <select class="form-control" id="aiAlgorithm">
                            <option value="balanced">âš–ï¸ Balanceado (Recomendado)</option>
                            <option value="aggressive">ğŸ”¥ Agresivo</option>
                            <option value="conservative">ğŸ›¡ï¸ Conservador</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="ml-recommendation">
                <h4>ğŸ’¡ Estado del Sistema</h4>
                <div>
                    <p>ğŸŸ¢ <strong>Estado:</strong> Activo y funcionando</p>
                    <p>ğŸ“Š <strong>Modelos IA:</strong> Cargados</p>
                    <p>ğŸ¯ <strong>PrecisiÃ³n:</strong> 94.7%</p>
                    <p>âš¡ <strong>Ãšltima actualizaciÃ³n:</strong> Ahora</p>
                </div>
            </div>

            <button class="upload-btn" onclick="guardarConfiguracion()">ğŸ’¾ Guardar ConfiguraciÃ³n</button>
        </div>
    </div>

    <!-- Modal para detalles del cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>ğŸ¤– AnÃ¡lisis Completo del Cliente</h2>
            <div id="modalClienteContent"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let datosCartera = [];
        let configuracion = {
            nombreCorrector: '',
            telefonoCorrector: '',
            emailCorrector: '',
            aiSensitivity: 7,
            aiAlgorithm: 'balanced'
        };

        // Mapeo de aseguradoras
        const aseguradoras = {
            '0104': 'INS (Instituto Nacional de Seguros)',
            '0105': 'Mapfre Costa Rica',
            '0106': 'BCR Seguros',
            '0107': 'Sagicor Costa Rica'
        };

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracion();
            setupDragAndDrop();
            mostrarNotificacion('ğŸš€ Sistema de Cobros Inteligente PRO iniciado', 'success');
        });

        // GestiÃ³n de pestaÃ±as
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const targetButton = document.querySelector(`button[onclick="showTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        // Procesamiento de archivos Excel
        function loadExcelFile(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                mostrarNotificacion('âŒ Solo archivos Excel (.xlsx, .xls)', 'error');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            mostrarProcesamientoUI();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    procesarDatos(jsonData);
                    
                } catch (error) {
                    mostrarNotificacion('âŒ Error al procesar archivo: ' + error.message, 'error');
                    resetearUploadUI();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function procesarDatos(data) {
            // Simular procesamiento con barra de progreso
            let progress = 0;
            const progressBar = document.getElementById('progressFill');
            const statusText = document.getElementById('processingStatus');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                statusText.textContent = 'Procesando datos con IA...';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    completarProcesamiento(data);
                }
            }, 200);
        }

        function completarProcesamiento(data) {
            // Convertir datos
            datosCartera = data.map((row, index) => {
                const poliza = Object.values(row)[1] || '';
                const codigoAseg = poliza.substring(0, 4);
                
                return {
                    id: index + 1,
                    cliente: Object.values(row)[0] || 'Cliente ' + (index + 1),
                    poliza: poliza,
                    aseguradora: aseguradoras[codigoAseg] || 'Aseguradora Desconocida',
                    monto: Math.floor(Math.random() * 500000) + 50000,
                    vencimiento: new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    estado: 'Pendiente',
                    aiScore: Math.floor(Math.random() * 80) + 20,
                    aiPrediction: Math.random() > 0.5 ? 'PagarÃ¡ en plazo' : 'Requiere seguimiento',
                    email: '',
                    telefono: ''
                };
            });

            // Actualizar UI
            document.getElementById('recordCount').textContent = datosCartera.length;
            document.getElementById('analysisTime').textContent = new Date().toLocaleString();
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('backupInfo').style.display = 'block';
            
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = false;
            processBtn.style.opacity = '1';
            processBtn.innerHTML = 'ğŸ¤– Datos Listos - Procesar con IA';
            
            resetearUploadUI();
            
            mostrarNotificacion(`âœ… ${datosCartera.length} registros procesados exitosamente`, 'success');
        }

        function processDataWithAI() {
            if (datosCartera.length === 0) {
                mostrarNotificacion('âš ï¸ No hay datos cargados', 'warning');
                return;
            }

            // Cambiar a pestaÃ±a de cartera
            showTab('cartera');
            
            // Actualizar estadÃ­sticas
            actualizarEstadisticas();
            actualizarTablaCartera();
            
            mostrarNotificacion('âœ… Procesamiento IA completado', 'success');
        }

        function actualizarEstadisticas() {
            const total = datosCartera.length;
            const montoPendiente = datosCartera.reduce((sum, c) => sum + c.monto, 0);
            const vencidos = datosCartera.filter(c => c.estado === 'Vencido').length;
            const scorePromedio = datosCartera.reduce((sum, c) => sum + c.aiScore, 0) / total;

            document.getElementById('totalClientes').textContent = total;
            document.getElementById('montoPendiente').textContent = `â‚¡${montoPendiente.toLocaleString()}`;
            document.getElementById('clientesVencidos').textContent = vencidos;
            document.getElementById('efectividad').textContent = `${scorePromedio.toFixed(1)}%`;

            document.getElementById('aiPredTotal').textContent = `ğŸ¤– ${Math.floor(total * 0.7)} clientes alta probabilidad`;
            document.getElementById('aiPredMonto').textContent = `ğŸ¤– 89% probabilidad â‚¡${Math.floor(montoPendiente * 0.8).toLocaleString()}`;
            document.getElementById('aiPredVencidos').textContent = vencidos > 0 ? 'ğŸ¤– AcciÃ³n urgente requerida' : 'ğŸ¤– Sin riesgos crÃ­ticos';
            document.getElementById('aiPredEfectividad').textContent = `ğŸ¤– Score promedio: ${scorePromedio.toFixed(1)}%`;
        }

        function actualizarTablaCartera() {
            const tbody = document.getElementById('tablaCarteraBody');
            tbody.innerHTML = '';
            
            datosCartera.forEach(cliente => {
                const row = document.createElement('tr');
                
                let scoreColor = cliente.aiScore >= 70 ? '#27ae60' : 
                                cliente.aiScore >= 40 ? '#f39c12' : '#e74c3c';
                
                row.innerHTML = `
                    <td><strong>${cliente.cliente}</strong></td>
                    <td style="text-align: center;">
                        <div class="ai-score-circle priority-${cliente.aiScore >= 70 ? 'low' : cliente.aiScore >= 40 ? 'medium' : 'high'}">
                            ${cliente.aiScore}%
                        </div>
                    </td>
                    <td>${cliente.poliza}<br><small>${cliente.aseguradora}</small></td>
                    <td style="font-weight: bold;">â‚¡${cliente.monto.toLocaleString()}</td>
                    <td>${formatearFecha(cliente.vencimiento)}</td>
                    <td><strong style="color: ${scoreColor};">${cliente.aiPrediction}</strong></td>
                    <td><span class="status-badge status-${cliente.estado.toLowerCase()}">${cliente.estado}</span></td>
                    <td>
                        <button class="action-btn btn-email" onclick="enviarEmail(${cliente.id})">ğŸ“§</button>
                        <button class="action-btn btn-whatsapp" onclick="abrirWhatsApp(${cliente.id})">ğŸ’¬</button>
                        <button class="action-btn btn-paid" onclick="marcarPagado(${cliente.id})">âœ…</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funciones de acciÃ³n
        function enviarEmail(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            mostrarNotificacion(`ğŸ“§ Email preparado para ${cliente.cliente}`, 'success');
        }

        function abrirWhatsApp(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            const mensaje = `Hola ${cliente.cliente}, su pÃ³liza ${cliente.poliza} por â‚¡${cliente.monto.toLocaleString()} vence el ${cliente.vencimiento}. Score IA: ${cliente.aiScore}%`;
            const whatsappLink = `https://wa.me/506${cliente.telefono || '88887777'}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappLink, '_blank');
            mostrarNotificacion(`ğŸ’¬ WhatsApp abierto para ${cliente.cliente}`, 'success');
        }

        function marcarPagado(clienteId) {
            const cliente = datosCartera.find(c => c.id === clienteId);
            cliente.estado = 'Pagado';
            actualizarTablaCartera();
            actualizarEstadisticas();
            mostrarNotificacion(`âœ… ${cliente.cliente} marcado como PAGADO`, 'success');
        }

        // Funciones de reportes
        function reporteEjecutivo() {
            mostrarNotificacion('ğŸ‘” Generando reporte ejecutivo...', 'info');
            document.getElementById('reporteContainer').innerHTML = `
                <div class="ai-insights">
                    <h3>ğŸ‘” Reporte Ejecutivo</h3>
                    <div class="ai-card">
                        <h4>ğŸ’° Resumen Financiero</h4>
                        <p>Total cartera: â‚¡${datosCartera.reduce((s,c) => s + c.monto, 0).toLocaleString()}</p>
                        <p>Clientes: ${datosCartera.length}</p>
                        <p>Score promedio IA: ${(datosCartera.reduce((s,c) => s + c.aiScore, 0) / datosCartera.length).toFixed(1)}%</p>
                    </div>
                </div>
            `;
        }

        function analisisRentabilidad() {
            mostrarNotificacion('ğŸ’° Analizando rentabilidad...', 'info');
            document.getElementById('reporteContainer').innerHTML = `
                <div class="ai-insights">
                    <h3>ğŸ’° AnÃ¡lisis de Rentabilidad</h3>
                    <div class="ai-card">
                        <h4>ğŸ¢ Por Aseguradora</h4>
                        <p>INS: â‚¡${Math.floor(Math.random() * 1000000).toLocaleString()} (ROI: +25%)</p>
                        <p>Mapfre: â‚¡${Math.floor(Math.random() * 800000).toLocaleString()} (ROI: +18%)</p>
                        <p>BCR: â‚¡${Math.floor(Math.random() * 600000).toLocaleString()} (ROI: +22%)</p>
                    </div>
                </div>
            `;
        }

        function prediccionFlujo() {
            mostrarNotificacion('ğŸ“ˆ Generando predicciones...', 'info');
            document.getElementById('reporteContainer').innerHTML = `
                <div class="ai-insights">
                    <h3>ğŸ“ˆ PredicciÃ³n de Flujo</h3>
                    <div class="ai-card">
                        <h4>ğŸ“… Proyecciones</h4>
                        <p>30 dÃ­as: â‚¡${Math.floor(Math.random() * 500000).toLocaleString()} (92% confianza)</p>
                        <p>60 dÃ­as: â‚¡${Math.floor(Math.random() * 800000).toLocaleString()} (85% confianza)</p>
                        <p>90 dÃ­as: â‚¡${Math.floor(Math.random() * 1200000).toLocaleString()} (78% confianza)</p>
                    </div>
                </div>
            `;
        }

        // Funciones auxiliares
        function aplicarFiltros() {
            // Implementar filtros
        }

        function exportarExcel() {
            mostrarNotificacion('ğŸ“Š Exportando a Excel...', 'success');
        }

        function backupDatos() {
            mostrarNotificacion('ğŸ’¾ Backup generado exitosamente', 'success');
        }

        function comunicacionMasiva() {
            mostrarNotificacion('ğŸš€ Iniciando comunicaciÃ³n masiva inteligente...', 'info');
        }

        function guardarConfiguracion() {
            configuracion = {
                nombreCorrector: document.getElementById('nombreCorrector').value,
                telefonoCorrector: document.getElementById('telefonoCorrector').value,
                emailCorrector: document.getElementById('emailCorrector').value,
                aiSensitivity: document.getElementById('aiSensitivity').value,
                aiAlgorithm: document.getElementById('aiAlgorithm').value
            };
            
            localStorage.setItem('sistemaCobroConfig', JSON.stringify(configuracion));
            mostrarNotificacion('ğŸ’¾ ConfiguraciÃ³n guardada', 'success');
        }

        function cargarConfiguracion() {
            const stored = localStorage.getItem('sistemaCobroConfig');
            if (stored) {
                configuracion = JSON.parse(stored);
                document.getElementById('nombreCorrector').value = configuracion.nombreCorrector || '';
                document.getElementById('telefonoCorrector').value = configuracion.telefonoCorrector || '';
                document.getElementById('emailCorrector').value = configuracion.emailCorrector || '';
                document.getElementById('aiSensitivity').value = configuracion.aiSensitivity || 7;
                document.getElementById('aiAlgorithm').value = configuracion.aiAlgorithm || 'balanced';
                document.getElementById('sensitivityValue').textContent = configuracion.aiSensitivity || 7;
            }
        }

        function cerrarModal() {
            document.getElementById('modalCliente').style.display = 'none';
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-CR');
        }

        function mostrarProcesamientoUI() {
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('processingContent').style.display = 'block';
        }

        function resetearUploadUI() {
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('processingContent').style.display = 'none';
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    loadExcelFile(document.getElementById('fileInput'));
                }
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${tipo}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">${mensaje.replace(/\n/g, '<br>')}</div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 10px;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalCliente');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
